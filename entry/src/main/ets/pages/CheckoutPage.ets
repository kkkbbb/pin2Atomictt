import { hilog } from '@kit.PerformanceAnalysisKit';
import { router, window, promptAction } from '@kit.ArkUI';
import { appState, CartItem, CartBoxInfo } from '../services/AppStorage';
import { apiService } from '../services/ApiService';
import {
  OrderType,
  AddOrderRequest,
  OrderProduct,
  OrderCondiment,
  OrderPolicyProduct,
  OrderBoxInfo,
  PackageItemPrice
} from '../models/StoreModels';
import { AppConfig } from '../config/AppConfig';

const DOMAIN = 0x0000;
const TAG = 'CheckoutPage';

/**
 * åŒºå·é€‰é¡¹
 */
interface AreaCode {
  code: string;
  name: string;
}

@Entry
@Component
struct CheckoutPage {
  @State isLoading: boolean = true;
  @State orderType: OrderType = OrderType.PICKUP;
  @State themeColor: string = '#FFD700';
  @State currencySymbol: string = '$';
  @State topSafeHeight: number = 0;

  // åº—é“ºä¿¡æ¯
  @State storeName: string = '';
  @State storeAddress: string = '';

  // è´­ç‰©è½¦æ•°æ®
  @State cartItems: CartItem[] = [];
  @State cartTotal: number = 0;
  @State cartCount: number = 0;

  // è´¹ç”¨æ˜ç»†
  @State boxFee: number = 0;         // é¤ç›’è´¹ï¼ˆä»è´­ç‰©è½¦å•†å“è·å–ï¼Œ0è¡¨ç¤ºæ— é¤ç›’è´¹ï¼‰
  @State boxInfo: CartBoxInfo | null = null;  // é¤ç›’è´¹è¯¦æƒ…
  @State voucherDiscount: number = 0; // å…‘æ¢åˆ¸æŠ˜æ‰£
  @State couponDiscount: number = 0;  // ä¼˜æƒ åˆ¸æŠ˜æ‰£

  // è”ç³»ä¿¡æ¯
  @State email: string = '';
  @State selectedAreaCode: AreaCode = { code: '+852', name: 'ä¸­åœ‹é¦™æ¸¯' };
  @State phone: string = '';
  @State remark: string = '';

  // åŒºå·åˆ—è¡¨
  private areaCodes: AreaCode[] = [
    { code: '+852', name: 'ä¸­åœ‹é¦™æ¸¯' },
    { code: '+86', name: 'ä¸­åœ‹å¤§é™¸' },
    { code: '+853', name: 'æ¾³é–€' },
    { code: '+886', name: 'å°ç£' },
    { code: '+65', name: 'æ–°åŠ å¡' },
    { code: '+60', name: 'é¦¬ä¾†è¥¿äº' }
  ];

  @State showAreaCodePicker: boolean = false;
  @State isSubmitting: boolean = false;

  aboutToAppear() {
    // è·å–è·¯ç”±å‚æ•°
    const params = router.getParams() as Record<string, Object>;
    if (params) {
      if (params['orderType']) {
        this.orderType = params['orderType'] as OrderType;
      }
      if (params['themeColor']) {
        this.themeColor = params['themeColor'] as string;
      }
      if (params['currencySymbol']) {
        this.currencySymbol = params['currencySymbol'] as string;
      }
      if (params['storeName']) {
        this.storeName = params['storeName'] as string;
      }
      if (params['storeAddress']) {
        this.storeAddress = params['storeAddress'] as string;
      }
    }

    this.loadData();
    this.getTopSafeHeight();
  }

  private async getTopSafeHeight(): Promise<void> {
    try {
      const win = await window.getLastWindow(getContext(this));
      const avoidArea = win.getWindowAvoidArea(window.AvoidAreaType.TYPE_SYSTEM);
      this.topSafeHeight = px2vp(avoidArea.topRect.height);
    } catch (error) {
      hilog.error(DOMAIN, TAG, 'Failed to get safe area: %{public}s', JSON.stringify(error));
      this.topSafeHeight = 44;
    }
  }

  private async loadData(): Promise<void> {
    // åŠ è½½è´­ç‰©è½¦æ•°æ®
    this.cartItems = appState.cartItems;
    this.cartTotal = appState.cartTotal;
    this.cartCount = appState.cartCount;

    // è®¡ç®—é¤ç›’è´¹ï¼ˆå¤–å–è‡ªå–æ—¶æ”¶å–ï¼Œä¸”éœ€è¦å•†å®¶é…ç½®äº†é¤ç›’è´¹ï¼‰
    this.boxFee = 0;
    this.boxInfo = null;
    if (this.orderType === OrderType.PICKUP) {
      // ä»è´­ç‰©è½¦ä¸­æ‰¾åˆ°ç¬¬ä¸€ä¸ªæœ‰é¤ç›’è´¹é…ç½®çš„å•†å“
      for (const item of this.cartItems) {
        if (item.boxInfo && item.boxInfo.price > 0) {
          this.boxInfo = item.boxInfo;
          this.boxFee = item.boxInfo.price;
          break;
        }
      }
    }

    // å¦‚æœåº—é“ºä¿¡æ¯ä¸ºç©ºï¼Œä»APIè·å–
    if (!this.storeName || !this.storeAddress) {
      await this.loadStoreInfo();
    }

    this.isLoading = false;
    hilog.info(DOMAIN, TAG, 'Cart loaded: %{public}d items, total: %{public}d',
      this.cartCount, this.cartTotal);
  }

  /**
   * åŠ è½½åº—é“ºä¿¡æ¯
   */
  private async loadStoreInfo(): Promise<void> {
    try {
      const response = await apiService.getHomeData();
      if (response.code === 200 && response.data) {
        const config = response.data.config;
        if (!this.storeName) {
          this.storeName = config.name || '';
        }
        if (!this.storeAddress) {
          this.storeAddress = config.address || '';
        }
        hilog.info(DOMAIN, TAG, 'Store info loaded: %{public}s', this.storeName);
      }
    } catch (error) {
      hilog.error(DOMAIN, TAG, 'Failed to load store info: %{public}s', JSON.stringify(error));
    }
  }

  // è·å–æ€»è®¡é‡‘é¢
  private getTotalAmount(): number {
    return this.cartTotal + this.boxFee - this.voucherDiscount - this.couponDiscount;
  }

  // è·å–è®¢å•ç±»å‹æ–‡æœ¬
  private getOrderTypeText(): string {
    switch (this.orderType) {
      case OrderType.PICKUP:
        return 'å¤–è³£è‡ªå–';
      case OrderType.DINE_IN:
        return 'å ‚é£Ÿ';
      case OrderType.DELIVERY:
        return 'å¤–é€';
      default:
        return '';
    }
  }

  // è¿”å›ä¸Šä¸€é¡µ
  private goBack(): void {
    router.back();
  }

  // ä¿®æ”¹èœå“ï¼ˆè¿”å›èœå•é¡µï¼‰
  private modifyItems(): void {
    router.back();
  }

  // æäº¤è®¢å•
  private async submitOrder(): Promise<void> {
    // éªŒè¯æ‰‹æœºå·
    if (!this.phone) {
      promptAction.showToast({
        message: 'è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼',
        duration: 2000
      });
      return;
    }

    // éªŒè¯è´­ç‰©è½¦
    if (this.cartItems.length === 0) {
      promptAction.showToast({
        message: 'è³¼ç‰©è»Šç‚ºç©º',
        duration: 2000
      });
      return;
    }

    if (this.isSubmitting) {
      return;
    }

    this.isSubmitting = true;
    hilog.info(DOMAIN, TAG, 'Submitting order, total: %{public}d', this.getTotalAmount());

    try {
      // æ„å»ºè®¢å•å•†å“æ•°æ®
      const products: OrderProduct[] = this.buildOrderProducts();

      // æ„å»ºè®¢å•è¯·æ±‚
      const orderRequest: AddOrderRequest = {
        store_id: AppConfig.DEFAULT_STORE_ID,
        table_id: 0,
        order_type: this.orderType,
        order_sub_type: 0,
        customer_num: 0,
        language: AppConfig.DEFAULT_LANG_CODE,
        comment: this.remark,
        products: products,
        total: this.getTotalAmount().toFixed(4),
        discount_total: 0,
        activity_discount_total: 0,
        seat_fee: 0,
        service_fee: '0.0000',
        email: this.email,
        telephone: this.phone,
        telephone_area_code: this.selectedAreaCode.code,
        coupon_total: this.couponDiscount > 0 ? this.couponDiscount : null,
        coupon_id: null,
        form_id: '',
        member_id: '',
        delivery_fee: 0,
        order_id: '',
        qr_code: null,
        table_group_name: null,
        cutlery_num: -1,
        cutlery_total: 0,
        need_cutlery_num: 0,
        member_discount_total: 0
      };

      hilog.info(DOMAIN, TAG, 'Order request: products=%{public}d', products.length);

      const response = await apiService.addOrder(orderRequest);

      if (response.code === 200 && response.data) {
        hilog.info(DOMAIN, TAG, 'Order submitted successfully: order_id=%{public}d',
          response.data.order_id);

        // æ¸…ç©ºè´­ç‰©è½¦
        await appState.clearCart();

        // è·³è½¬åˆ°è®¢å•è¯¦æƒ…é¡µè¿›è¡Œæ”¯ä»˜
        router.pushUrl({
          url: 'pages/OrderDetailPage',
          params: {
            orderId: response.data.order_id,
            themeColor: this.themeColor
          }
        });
      } else {
        hilog.error(DOMAIN, TAG, 'Order submit failed: %{public}s', response.msg);
        promptAction.showToast({
          message: response.msg || 'è¨‚å–®æäº¤å¤±æ•—',
          duration: 2000
        });
      }
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : JSON.stringify(error);
      hilog.error(DOMAIN, TAG, 'Order submit error: %{public}s', errorMsg);
      promptAction.showToast({
        message: 'ç¶²çµ¡éŒ¯èª¤ï¼Œè«‹é‡è©¦',
        duration: 2000
      });
    } finally {
      this.isSubmitting = false;
    }
  }

  /**
   * æ„å»ºè®¢å•å•†å“æ•°æ®
   */
  private buildOrderProducts(): OrderProduct[] {
    const products: OrderProduct[] = [];
    let isFirstItem = true;  // åªä¸ºç¬¬ä¸€ä¸ªå•†å“æ·»åŠ ç›’è´¹

    for (const cartItem of this.cartItems) {
      // ä½¿ç”¨è´­ç‰©è½¦ä¸­ä¿å­˜çš„è§„æ ¼ç 
      const standardCode = cartItem.standardCode || '';

      // æ„å»ºé…æ–™ä¿¡æ¯ï¼ˆåŒ¹é…H5æ ¼å¼ï¼Œæ·»åŠ é˜²å¾¡æ€§å¤„ç†ï¼‰
      const condiments: OrderCondiment[] = [];
      if (cartItem.packageSelections && cartItem.packageSelections.length > 0) {
        for (const pkgSelection of cartItem.packageSelections) {
          if (pkgSelection.items && pkgSelection.items.length > 0) {
            for (const item of pkgSelection.items) {
              const addPrice = item.addPrice ?? 0;
              const itemName = item.name || '';
              condiments.push({
                condiment_item_id: item.productId || '',
                group_id: pkgSelection.groupId || '',
                local_name: itemName,
                en_name: itemName,
                cn_name: '',
                display_order: '0',
                price: addPrice.toFixed(4),
                takeout_price: addPrice.toFixed(4),
                delivery_price: addPrice.toFixed(4),
                short_name: '',
                barcode: '',
                status_id: '1',
                default_type: '1',
                standard_code: '',
                is_default: '0',
                quantity: 1
              });
            }
          }
        }
      }

      // æ„å»ºåŠ é€å•†å“ä¿¡æ¯
      const policyProducts: OrderPolicyProduct[][] = [];
      if (cartItem.policySelections && cartItem.policySelections.length > 0) {
        for (const policySelection of cartItem.policySelections) {
          const policyItem = policySelection.item;
          if (!policyItem) continue;

          // æ„å»ºé…æ–™ä¿¡æ¯ï¼ˆä½¿ç”¨çœŸå®æ•°æ®ï¼ŒåŒ¹é…H5æ ¼å¼ï¼‰
          const policyCondiments: OrderCondiment[] = [];
          if (policyItem.condiments && policyItem.condiments.length > 0) {
            for (const condiment of policyItem.condiments) {
              // é˜²å¾¡æ€§å¤„ç†ï¼šç¡®ä¿æ‰€æœ‰å­—æ®µæœ‰é»˜è®¤å€¼
              const price = condiment.price ?? 0;
              const takeoutPrice = condiment.takeoutPrice ?? price;
              const deliveryPrice = condiment.deliveryPrice ?? price;
              const itemName = condiment.itemName || '';
              const condStdCode = condiment.standardCode || policyItem.standardCode || '';
              policyCondiments.push({
                condiment_item_id: condiment.itemId || '',
                group_id: condiment.groupId || '',
                local_name: itemName,
                en_name: itemName,
                cn_name: '',
                display_order: '0',
                price: price.toFixed(4),
                takeout_price: takeoutPrice.toFixed(4),
                delivery_price: deliveryPrice.toFixed(4),
                short_name: '',
                barcode: '',
                status_id: '1',
                default_type: '1',
                standard_code: condStdCode,
                is_default: condiment.isDefault || '1',
                quantity: 1
              });
            }
          }

          // æ„å»º prices æ•°ç»„ï¼ˆä½¿ç”¨åŸå§‹æ•°æ®ï¼Œæ·»åŠ é˜²å¾¡æ€§å¤„ç†ï¼‰
          const prices: PackageItemPrice[] = [];
          if (policyItem.originalPrices && policyItem.originalPrices.length > 0) {
            for (const p of policyItem.originalPrices) {
              prices.push({
                standard_code: p.standardCode || '',
                local_name: p.localName || '',
                en_name: p.enName || '',
                cn_name: '',
                short_name: p.localName || '',
                add_price: p.addPrice || '0.00',
                add_takeout_price: p.addTakeoutPrice || '0.00',
                add_delivery_price: p.addDeliveryPrice || '0.00',
                num: 0
              });
            }
          }

          // è·å–é€‰ä¸­çš„è§„æ ¼
          const selectedPrice = prices.length > policyItem.priceIndex
            ? prices[policyItem.priceIndex]
            : (prices.length > 0 ? prices[0] : null);

          // æ„å»ºåŠ é€å•†å“ï¼ˆåŒ¹é…H5æ ¼å¼ï¼Œæ·»åŠ é˜²å¾¡æ€§å¤„ç†ï¼‰
          const productId = policyItem.productId || '';
          const productName = policyItem.name || '';
          const shortName = policyItem.shortName || productName;
          const priceName = policyItem.priceName || '';
          const stdCode = policyItem.standardCode || '';
          const addPriceNum = policyItem.addPrice ?? 0;

          const policyProduct: OrderPolicyProduct = {
            product_id: productId,
            store_id: AppConfig.DEFAULT_STORE_ID,
            scheme_id: '0',
            local_name: productName,
            cn_name: '',
            en_name: productName,
            short_name: shortName,
            status: '1',
            takeout: '1',
            cover_image: policyItem.coverImage || '',
            has_stock: '1',
            stock_number: '0',
            prices: prices,
            description: {
              product_id: productId,
              language_id: '1',
              name: productName,
              cn_description: '',
              local_description: '',
              en_description: '',
              barcode: ''
            },
            box: null,
            unit_id: 0,
            max_count: 0,
            condiment_group: [],
            condiments: policyCondiments,
            policy_id: policySelection.policyId || '',
            group_id: policySelection.groupId || '',
            select_price: selectedPrice || {
              standard_code: stdCode,
              local_name: priceName,
              en_name: priceName,
              cn_name: '',
              short_name: priceName,
              add_price: addPriceNum.toFixed(2),
              add_takeout_price: addPriceNum.toFixed(2),
              add_delivery_price: addPriceNum.toFixed(2),
              num: 0
            },
            quantity: 1,
            version: 'v1.9',
            add_price: addPriceNum,
            standard_code: stdCode,
            price: addPriceNum.toFixed(2),
            product_name: null
          };

          policyProducts.push([policyProduct]);
        }
      }

      // æ„å»ºè®¢å•å•†å“
      // åªä¸ºç¬¬ä¸€ä¸ªå•†å“æ·»åŠ ç›’è´¹ï¼Œé¿å…é‡å¤è®¡è´¹ï¼ˆéœ€è¦å•†å®¶é…ç½®äº†é¤ç›’è´¹ï¼‰
      const boxInfo = (this.orderType === OrderType.PICKUP && isFirstItem && this.boxInfo)
        ? this.buildBoxInfo(cartItem)
        : null;

      const orderProduct: OrderProduct = {
        product_id: cartItem.productId,
        group_id: cartItem.groupId || '',
        standard_code: standardCode,
        condiments: condiments,
        quantity: cartItem.quantity,
        price: cartItem.basePrice,
        activity_id: null,
        box: boxInfo,
        store_id: AppConfig.DEFAULT_STORE_ID,
        dine_in_takeout: 0,
        member_discount_id: null,
        policy_products: policyProducts
      };

      products.push(orderProduct);
      isFirstItem = false;  // åç»­å•†å“ä¸å†æ·»åŠ ç›’è´¹
    }

    return products;
  }

  /**
   * æ„å»ºå¤–å–ç›’ä¿¡æ¯
   */
  private buildBoxInfo(cartItem: CartItem): OrderBoxInfo | null {
    // å¤–å–è‡ªå–æ—¶æ·»åŠ é¤ç›’è´¹ï¼ˆéœ€è¦æœ‰é¤ç›’è´¹é…ç½®ï¼‰
    if (this.orderType === OrderType.PICKUP && this.boxInfo) {
      const priceStr = this.boxInfo.price.toFixed(4);
      const orderBoxInfo: OrderBoxInfo = {
        id: '',
        product_id: cartItem.productId,
        box_id: this.boxInfo.boxId,
        box: {
          box_id: this.boxInfo.boxId,
          store_id: AppConfig.DEFAULT_STORE_ID,
          local_name: this.boxInfo.localName,
          en_name: this.boxInfo.enName,
          cn_name: '',
          price: priceStr
        },
        store_id: AppConfig.DEFAULT_STORE_ID,
        local_name: this.boxInfo.localName,
        en_name: this.boxInfo.enName,
        cn_name: '',
        price: priceStr,
        display_order: '0'
      };
      return orderBoxInfo;
    }
    return null;
  }

  build() {
    Stack({ alignContent: Alignment.Bottom }) {
      Column() {
        // é¡¶éƒ¨å®‰å…¨åŒºåŸŸ
        Column()
          .width('100%')
          .height(this.topSafeHeight)
          .backgroundColor('#F5F5F5')

        // ä¸»å†…å®¹åŒº
        Scroll() {
          Column() {
            // å¡ç‰‡1: åº—é“ºåœ°å€
            this.StoreAddressCard()

            // å¡ç‰‡2: è®¢å•ä¿¡æ¯ï¼ˆè®¢å•ç±»å‹+å•†å“+è´¹ç”¨+æ€»è®¡ï¼‰
            this.OrderCard()

            // å¡ç‰‡3: è”ç³»ä¿¡æ¯+å¤‡æ³¨
            this.ContactCard()

            // éšç§æ¡æ¬¾
            this.PrivacySection()

            // åº•éƒ¨å ä½ï¼ˆç»™ç»“ç®—æ ç•™ç©ºé—´ï¼‰
            Column()
              .width('100%')
              .height(80)
          }
          .width('100%')
          .padding({ left: 12, right: 12 })
        }
        .layoutWeight(1)
        .scrollBar(BarState.Off)
        .backgroundColor('#F5F5F5')
      }
      .width('100%')
      .height('100%')

      // åº•éƒ¨ç»“ç®—æ 
      this.BottomBar()

      // åŒºå·é€‰æ‹©å¼¹çª—
      if (this.showAreaCodePicker) {
        Column() {
          // é®ç½©å±‚
          Column()
            .width('100%')
            .layoutWeight(1)
            .backgroundColor('rgba(0, 0, 0, 0.4)')
            .onClick(() => {
              this.showAreaCodePicker = false;
            })

          // å¼¹çª—å†…å®¹
          this.AreaCodePickerDialog()
        }
        .width('100%')
        .height('100%')
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  // å¡ç‰‡1: åº—é“ºåœ°å€
  @Builder
  StoreAddressCard() {
    Row() {
      // å®šä½å›¾æ ‡
      Image($r('app.media.icon_location'))
        .width(18)
        .height(18)
        .fillColor('#333333')
        .margin({ right: 8 })

      Column() {
        Text(this.storeName || 'æœªçŸ¥åº—é“º')
          .fontSize(15)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')

        Text(this.storeAddress || 'æœªçŸ¥åœ°å€')
          .fontSize(13)
          .fontColor('#999999')
          .margin({ top: 6 })
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 16, bottom: 16 })
    .backgroundColor('#FFFFFF')
    .borderRadius(8)
    .margin({ top: 12 })
    .alignItems(VerticalAlign.Top)
  }

  // å¡ç‰‡2: è®¢å•ä¿¡æ¯ï¼ˆè®¢å•ç±»å‹+å•†å“+è´¹ç”¨+æ€»è®¡ï¼‰
  @Builder
  OrderCard() {
    Column() {
      // è®¢å•ç±»å‹å¤´éƒ¨
      Row() {
        Text(this.getOrderTypeText())
          .fontSize(15)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')

        Blank()

        Text('ä¿®æ”¹èœå“')
          .fontSize(14)
          .fontColor('#333333')
          .fontWeight(FontWeight.Medium)
          .onClick(() => {
            this.modifyItems();
          })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 14, bottom: 14 })

      // å•†å“åˆ—è¡¨
      ForEach(this.cartItems, (item: CartItem, index: number) => {
        this.CartItemRow(item)
      })

      // è´¹ç”¨æ˜ç»†
      this.FeeDetailSection()

      // æ€»è®¡
      this.TotalSection()
    }
    .width('100%')
    .backgroundColor('#FFFFFF')
    .borderRadius(8)
    .margin({ top: 10 })
  }

  // è´­ç‰©è½¦å•†å“è¡Œ
  @Builder
  CartItemRow(item: CartItem) {
    Row() {
      // å•†å“å›¾ç‰‡
      Image(item.coverImage || $r('app.media.startIcon'))
        .width(60)
        .height(60)
        .borderRadius(6)
        .objectFit(ImageFit.Cover)

      // å•†å“ä¿¡æ¯
      Column() {
        Text(item.productName)
          .fontSize(14)
          .fontColor('#333333')
          .fontWeight(FontWeight.Medium)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        if (item.specDescription) {
          Text(item.specDescription)
            .fontSize(12)
            .fontColor('#999999')
            .margin({ top: 4 })
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)
      .margin({ left: 12 })

      // ä»·æ ¼å’Œæ•°é‡
      Column() {
        Text(`${this.currencySymbol}${item.unitPrice.toFixed(0)}`)
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .fontWeight(FontWeight.Medium)

        Text(`x${item.quantity}`)
          .fontSize(12)
          .fontColor('#999999')
          .margin({ top: 4 })
      }
      .alignItems(HorizontalAlign.End)
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 12, bottom: 12 })
    .alignItems(VerticalAlign.Center)
    .backgroundColor('#FFFFFF')
  }

  // è´¹ç”¨æ˜ç»†
  @Builder
  FeeDetailSection() {
    Column() {
      // é¤ç›’è´¹ï¼ˆåªæœ‰å½“å•†å®¶é…ç½®äº†é¤ç›’è´¹æ—¶æ‰æ˜¾ç¤ºï¼‰
      if (this.boxFee > 0) {
        Row() {
          Text('é¤ç›’è²»')
            .fontSize(14)
            .fontColor('#333333')
          Blank()
          Text(`${this.currencySymbol}${this.boxFee.toFixed(0)}`)
            .fontSize(14)
            .fontColor('#333333')
        }
        .width('100%')
        .padding({ top: 14, bottom: 14 })

        Divider().color('#F5F5F5').strokeWidth(1)
      }

      // å…‘æ¢åˆ¸
      Row() {
        Text('å…Œæ›åˆ¸')
          .fontSize(14)
          .fontColor('#333333')
        Blank()
        Text(this.voucherDiscount > 0 ? `-${this.currencySymbol}${this.voucherDiscount.toFixed(0)}` : 'ç„¡å¯ç”¨å…Œæ›åˆ¸')
          .fontSize(14)
          .fontColor(this.voucherDiscount > 0 ? '#333333' : '#999999')
          .fontWeight(this.voucherDiscount > 0 ? FontWeight.Medium : FontWeight.Normal)
      }
      .width('100%')
      .padding({ top: 14, bottom: 14 })

      Divider().color('#F5F5F5').strokeWidth(1)

      // ä¼˜æƒ åˆ¸
      Row() {
        Text('å„ªæƒ åˆ¸')
          .fontSize(14)
          .fontColor('#333333')

        // è¾“å…¥ä¼˜æƒ ç æŒ‰é’®
        Text('è¼¸å…¥å„ªæƒ ç¢¼')
          .fontSize(12)
          .fontColor('#F5A623')
          .padding({ left: 10, right: 10, top: 4, bottom: 4 })
          .borderRadius(4)
          .borderWidth(1)
          .borderColor('#F5A623')
          .margin({ left: 12 })

        Blank()

        Text(this.couponDiscount > 0 ? `-${this.currencySymbol}${this.couponDiscount.toFixed(0)}` : 'ç„¡å¯ç”¨å„ªæƒ åˆ¸')
          .fontSize(14)
          .fontColor(this.couponDiscount > 0 ? '#333333' : '#999999')
          .fontWeight(this.couponDiscount > 0 ? FontWeight.Medium : FontWeight.Normal)
      }
      .width('100%')
      .padding({ top: 14, bottom: 14 })
    }
    .width('100%')
    .padding({ left: 16, right: 16 })
    .backgroundColor('#FFFFFF')
  }

  // æ€»è®¡
  @Builder
  TotalSection() {
    Row() {
      Blank()
      Text(`å…±${this.cartCount}ä»¶èœå“ï¼Œæ‡‰ä»˜`)
        .fontSize(14)
        .fontColor('#666666')

      Text(` ${this.currencySymbol}${this.getTotalAmount().toFixed(0)}`)
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor(this.themeColor)
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 14, bottom: 14 })
    .backgroundColor('#FFFFFF')
  }

  // å¡ç‰‡3: è”ç³»ä¿¡æ¯
  @Builder
  ContactCard() {
    Column() {
      // é‚®ç®±
      Row() {
        Text('éƒµç®±')
          .fontSize(14)
          .fontColor('#333333')
          .width(70)

        TextInput({ placeholder: 'å»ºè­°å¡«å¯«ï¼Œç”¨æ–¼æ¥æ”¶è¨‚å–®é€šçŸ¥', text: this.email })
          .fontSize(14)
          .placeholderColor('#CCCCCC')
          .placeholderFont({ size: 14 })
          .backgroundColor('transparent')
          .layoutWeight(1)
          .padding({ left: 0 })
          .onChange((value: string) => {
            this.email = value;
          })
      }
      .width('100%')
      .height(50)
      .alignItems(VerticalAlign.Center)

      Divider().color('#F5F5F5').strokeWidth(1)

      // æ‰‹æœºå·ç 
      Row() {
        Text('æ‰‹æ©Ÿè™Ÿç¢¼')
          .fontSize(14)
          .fontColor('#333333')
          .width(70)

        // åŒºå·é€‰æ‹©
        Row() {
          Text(`${this.selectedAreaCode.name} ${this.selectedAreaCode.code}`)
            .fontSize(14)
            .fontColor('#333333')
          .fontWeight(FontWeight.Medium)
          Text(' â–¼')
            .fontSize(10)
            .fontColor('#333333')
          .fontWeight(FontWeight.Medium)
        }
        .onClick(() => {
          this.showAreaCodePicker = true;
        })

        // åˆ†éš”çº¿
        Divider()
          .vertical(true)
          .height(14)
          .color('#DDDDDD')
          .margin({ left: 10, right: 10 })

        TextInput({ placeholder: 'è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼', text: this.phone })
          .fontSize(14)
          .placeholderColor('#CCCCCC')
          .placeholderFont({ size: 14 })
          .backgroundColor('transparent')
          .layoutWeight(1)
          .padding({ left: 0 })
          .type(InputType.PhoneNumber)
          .onChange((value: string) => {
            this.phone = value;
          })
      }
      .width('100%')
      .height(50)
      .alignItems(VerticalAlign.Center)

      // æç¤ºä¿¡æ¯
      Row() {
        Text('ğŸ’¡')
          .fontSize(14)
          .margin({ right: 6 })
        Text('è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼ï¼Œå¦‚è¨‚å–®æœ‰ä»»ä½•ä¿®æ”¹æˆ–æŸ¥è©¢ï¼Œåº—å“¡æœƒè‡´é›»é€šçŸ¥é–£ä¸‹æœ‰é—œæƒ…æ³')
          .fontSize(12)
          .fontColor('#F5A623')
          .layoutWeight(1)
      }
      .width('100%')
      .padding(12)
      .backgroundColor('#FFFBEB')
      .borderRadius(6)
      .margin({ top: 8 })

      Divider().color('#F5F5F5').strokeWidth(1).margin({ top: 16 })

      // å¤‡æ³¨
      Row() {
        Text('å‚™è¨»')
          .fontSize(14)
          .fontColor('#333333')
          .width(70)

        TextInput({ placeholder: '', text: this.remark })
          .fontSize(14)
          .placeholderColor('#CCCCCC')
          .backgroundColor('transparent')
          .layoutWeight(1)
          .padding({ left: 0 })
          .onChange((value: string) => {
            this.remark = value;
          })

        Text('>')
          .fontSize(18)
          .fontColor('#CCCCCC')
      }
      .width('100%')
      .height(50)
      .alignItems(VerticalAlign.Center)
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(8)
    .margin({ top: 10 })
  }

  // éšç§æ¡æ¬¾
  @Builder
  PrivacySection() {
    Text() {
      Span('ä¸Šæ–¹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼å³è¡¨ç¤ºä½ åŒæ„PinMeä¹‹ ')
        .fontSize(12)
        .fontColor('#999999')
      Span('ç§éš±æ”¿ç­–')
        .fontSize(12)
        .fontColor('#333333')
          .fontWeight(FontWeight.Medium)
      Span('/')
        .fontSize(12)
        .fontColor('#999999')
      Span('ä½¿ç”¨æ¢æ¬¾')
        .fontSize(12)
        .fontColor('#333333')
          .fontWeight(FontWeight.Medium)
    }
    .width('100%')
    .padding({ top: 16, bottom: 16 })
    .textAlign(TextAlign.Center)
  }

  // åº•éƒ¨ç»“ç®—æ 
  @Builder
  BottomBar() {
    Row() {
      // æ€»è®¡
      Row() {
        Text('ç¸½è¨ˆ ')
          .fontSize(14)
          .fontColor('#333333')
        Text(`${this.currencySymbol}${this.getTotalAmount().toFixed(0)}`)
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
      }
      .layoutWeight(1)

      // æäº¤è®¢å•æŒ‰é’®
      Button(this.isSubmitting ? 'æäº¤ä¸­...' : 'æäº¤è¨‚å–®')
        .fontSize(15)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')
        .backgroundColor(this.isSubmitting ? '#CCCCCC' : this.themeColor)
        .borderRadius(6)
        .height(42)
        .padding({ left: 28, right: 28 })
        .enabled(!this.isSubmitting)
        .onClick(() => {
          this.submitOrder();
        })
    }
    .width('100%')
    .height(60)
    .padding({ left: 16, right: 16 })
    .backgroundColor('#FFFFFF')
    .shadow({
      radius: 8,
      color: 'rgba(0, 0, 0, 0.08)',
      offsetX: 0,
      offsetY: -2
    })
  }

  // åŒºå·é€‰æ‹©å¼¹çª—
  @Builder
  AreaCodePickerDialog() {
    Column() {
      // æ ‡é¢˜
      Text('é¸æ“‡å€è™Ÿ')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .padding({ top: 16, bottom: 16 })

      // åˆ†éš”çº¿
      Divider().color('#F5F5F5').strokeWidth(1)

      // åŒºå·åˆ—è¡¨
      List() {
        ForEach(this.areaCodes, (item: AreaCode) => {
          ListItem() {
            Row() {
              Text(`${item.name} ${item.code}`)
                .fontSize(15)
                .fontColor('#333333')

              Blank()

              if (this.selectedAreaCode.code === item.code) {
                Text('âœ“')
                  .fontSize(18)
                  .fontColor(this.themeColor)
              }
            }
            .width('100%')
            .height(50)
            .padding({ left: 16, right: 16 })
            .onClick(() => {
              this.selectedAreaCode = item;
              this.showAreaCodePicker = false;
            })
          }
        })
      }
      .width('100%')
      .layoutWeight(1)
      .divider({
        strokeWidth: 1,
        color: '#F5F5F5',
        startMargin: 16,
        endMargin: 16
      })

      // å–æ¶ˆæŒ‰é’®
      Button('å–æ¶ˆ')
        .fontSize(15)
        .fontColor('#666666')
        .backgroundColor('#F5F5F5')
        .borderRadius(6)
        .width('90%')
        .height(44)
        .margin({ top: 16, bottom: 16 })
        .onClick(() => {
          this.showAreaCodePicker = false;
        })
    }
    .width('100%')
    .height('50%')
    .backgroundColor('#FFFFFF')
    .borderRadius({ topLeft: 16, topRight: 16 })
  }
}
