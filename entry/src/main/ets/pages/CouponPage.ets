import { router, window } from '@kit.ArkUI';
import { hilog } from '@kit.PerformanceAnalysisKit';
import { authentication } from '@kit.AccountKit';
import { BusinessError } from '@kit.BasicServicesKit';
import { apiService, ApiConfig } from '../services/ApiService';
import { Coupon, CouponListData } from '../models/StoreModels';

const DOMAIN = 0x0000;
const TAG = 'CouponPage';

/**
 * Tabç±»å‹æšä¸¾
 */
enum CouponTabType {
  COUPON = 0,    // ä¼˜æƒ åˆ¸
  VOUCHER = 1    // å…‘æ¢åˆ¸
}

@Entry
@Component
struct CouponPage {
  @State currentTab: CouponTabType = CouponTabType.COUPON;
  @State isLoggedIn: boolean = false;
  @State isLoading: boolean = true;
  @State couponList: Coupon[] = [];
  @State voucherList: Coupon[] = [];
  @State couponCount: number = 0;
  @State voucherCount: number = 0;
  @State topSafeHeight: number = 0;  // é¡¶éƒ¨å®‰å…¨è·ç¦»ï¼ˆé¿å¼€èƒ¶å›Šï¼‰
  @State themeColor: string = '#FFD700';

  aboutToAppear() {
    hilog.info(DOMAIN, TAG, 'CouponPage loading...');
    this.getTopSafeHeight();
    this.parseRouterParams();
    this.loadCoupons();
  }

  build() {
    Column() {
      // é¡¶éƒ¨HeaderåŒºåŸŸï¼ˆåŒ…å«å®‰å…¨è·ç¦»å’ŒTabæ ï¼‰
      this.HeaderArea()

      // å†…å®¹åŒºåŸŸ
      if (this.isLoading) {
        this.LoadingView()
      } else if (!this.isLoggedIn) {
        this.LoginPromptView()
      } else {
        this.CouponListView()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.page_background'))
  }

  // é¡¶éƒ¨HeaderåŒºåŸŸï¼ˆé¿å¼€èƒ¶å›Šï¼‰
  @Builder
  HeaderArea() {
    Column() {
      // è¿”å›æŒ‰é’®è¡Œï¼ˆåœ¨å®‰å…¨åŒºåŸŸå†…ï¼‰
      Row() {
        // è¿”å›æŒ‰é’®
        Text('â€¹')
          .width(32)
          .height(32)
          .fontSize(28)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.text_primary'))
          .textAlign(TextAlign.Center)
          .onClick(() => {
            router.back();
          })

        Blank()
      }
      .width('100%')
      .padding({ left: 8, right: 8 })

      // Tabæ 
      this.TabBar()
    }
    .width('100%')
    .backgroundColor(Color.White)
    .padding({ top: this.topSafeHeight + 8 })
  }

  // Tabæ 
  @Builder
  TabBar() {
    Row() {
      // ä¼˜æƒ åˆ¸Tab
      Column() {
        Text(`å„ªæƒ åˆ¸(${this.couponCount})`)
          .fontSize(15)
          .fontColor(this.currentTab === CouponTabType.COUPON ?
            $r('app.color.text_primary') : $r('app.color.text_hint'))
          .fontWeight(this.currentTab === CouponTabType.COUPON ?
            FontWeight.Medium : FontWeight.Normal)

        // åº•éƒ¨æŒ‡ç¤ºçº¿
        Column()
          .width(50)
          .height(2)
          .backgroundColor(this.currentTab === CouponTabType.COUPON ?
            this.themeColor : Color.Transparent)
          .margin({ top: 10 })
          .borderRadius(1)
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Center)
      .padding({ top: 14, bottom: 6 })
      .onClick(() => {
        this.currentTab = CouponTabType.COUPON;
      })

      // å…‘æ¢åˆ¸Tab
      Column() {
        Text(`å…Œæ›åˆ¸(${this.voucherCount})`)
          .fontSize(15)
          .fontColor(this.currentTab === CouponTabType.VOUCHER ?
            $r('app.color.text_primary') : $r('app.color.text_hint'))
          .fontWeight(this.currentTab === CouponTabType.VOUCHER ?
            FontWeight.Medium : FontWeight.Normal)

        // åº•éƒ¨æŒ‡ç¤ºçº¿
        Column()
          .width(50)
          .height(2)
          .backgroundColor(this.currentTab === CouponTabType.VOUCHER ?
            this.themeColor : Color.Transparent)
          .margin({ top: 10 })
          .borderRadius(1)
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Center)
      .padding({ top: 14, bottom: 6 })
      .onClick(() => {
        this.currentTab = CouponTabType.VOUCHER;
      })
    }
    .width('100%')
    .backgroundColor(Color.White)
    .border({ width: { bottom: 1 }, color: '#F0F0F0' })
  }

  // åŠ è½½ä¸­è§†å›¾
  @Builder
  LoadingView() {
    Column() {
      LoadingProgress()
        .width(50)
        .height(50)
        .color(this.themeColor)
      Text('è¼‰å…¥ä¸­...')
        .fontSize(14)
        .fontColor($r('app.color.text_hint'))
        .margin({ top: 12 })
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }

  // æœªç™»å½•æç¤ºè§†å›¾
  @Builder
  LoginPromptView() {
    Column() {
      // ç™»å½•æŒ‰é’®
      Button('ç™»å…¥/è¨»å†Š')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor($r('app.color.text_primary'))
        .backgroundColor(this.themeColor)
        .borderRadius(24)
        .height(48)
        .width(140)
        .onClick(() => {
          this.loginWithHuaweiID();
        })

      // æç¤ºæ–‡å­—
      Row() {
        Text('ç™»å…¥')
          .fontSize(14)
          .fontColor('#4A90E2')
        Text('ï½œ')
          .fontSize(14)
          .fontColor($r('app.color.text_hint'))
        Text('è¨»å†Š')
          .fontSize(14)
          .fontColor('#4A90E2')
        Text('ï¼Œäº«æ›´å¤šå„ªæƒ ')
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
      }
      .margin({ top: 16 })
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }

  // ä¼˜æƒ åˆ¸åˆ—è¡¨è§†å›¾
  @Builder
  CouponListView() {
    Column() {
      if (this.currentTab === CouponTabType.COUPON) {
        if (this.couponList.length === 0) {
          this.EmptyView('æš«ç„¡å„ªæƒ åˆ¸')
        } else {
          this.CouponCards(this.couponList)
        }
      } else {
        if (this.voucherList.length === 0) {
          this.EmptyView('æš«ç„¡å…Œæ›åˆ¸')
        } else {
          this.CouponCards(this.voucherList)
        }
      }
    }
    .width('100%')
    .layoutWeight(1)
  }

  // ä¼˜æƒ åˆ¸å¡ç‰‡åˆ—è¡¨
  @Builder
  CouponCards(coupons: Coupon[]) {
    Scroll() {
      Column() {
        ForEach(coupons, (coupon: Coupon) => {
          this.CouponCard(coupon)
        }, (coupon: Coupon) => coupon.coupon_id)
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 16, bottom: 16 })
    }
    .width('100%')
    .layoutWeight(1)
    .scrollBar(BarState.Off)
  }

  // å•ä¸ªä¼˜æƒ åˆ¸å¡ç‰‡
  @Builder
  CouponCard(coupon: Coupon) {
    Row() {
      // å·¦ä¾§é‡‘é¢/æŠ˜æ‰£åŒºåŸŸ
      Column() {
        if (coupon.discount_type === 'percentage') {
          Row() {
            Text(coupon.discount_value)
              .fontSize(32)
              .fontWeight(FontWeight.Bold)
              .fontColor(Color.White)
            Text('%')
              .fontSize(16)
              .fontColor(Color.White)
              .margin({ left: 2, top: 8 })
          }
          Text('æŠ˜æ‰£')
            .fontSize(12)
            .fontColor(Color.White)
        } else if (coupon.discount_type === 'fixed') {
          Row() {
            Text('$')
              .fontSize(14)
              .fontColor(Color.White)
              .margin({ top: 4 })
            Text(coupon.discount_value)
              .fontSize(32)
              .fontWeight(FontWeight.Bold)
              .fontColor(Color.White)
          }
          Text('ç¾é‡‘åˆ¸')
            .fontSize(12)
            .fontColor(Color.White)
        } else {
          Text('å…è²»')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor(Color.White)
          Text('å…Œæ›')
            .fontSize(12)
            .fontColor(Color.White)
        }
      }
      .width(100)
      .height('100%')
      .justifyContent(FlexAlign.Center)
      .backgroundColor(this.themeColor)
      .borderRadius({ topLeft: 8, bottomLeft: 8 })

      // é”¯é½¿åˆ†éš”
      Column() {
        ForEach([0, 1, 2, 3, 4], () => {
          Column()
            .width(10)
            .height(10)
            .borderRadius(5)
            .backgroundColor($r('app.color.page_background'))
            .margin({ top: 4, bottom: 4 })
        })
      }
      .position({ x: 95, y: 0 })
      .height('100%')
      .justifyContent(FlexAlign.Center)

      // å³ä¾§è¯¦æƒ…åŒºåŸŸ
      Column() {
        Text(coupon.local_name || coupon.name)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor($r('app.color.text_primary'))
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        if (coupon.min_order_amount) {
          Text(`æ»¿$${coupon.min_order_amount}å¯ç”¨`)
            .fontSize(12)
            .fontColor($r('app.color.text_hint'))
            .margin({ top: 4 })
        }

        Text(`æœ‰æ•ˆæœŸè‡³ ${this.formatDate(coupon.end_date)}`)
          .fontSize(12)
          .fontColor($r('app.color.text_hint'))
          .margin({ top: 4 })

        // ä½¿ç”¨æŒ‰é’®
        Button('ç«‹å³ä½¿ç”¨')
          .fontSize(12)
          .fontColor(this.themeColor)
          .backgroundColor(Color.Transparent)
          .border({ width: 1, color: this.themeColor })
          .borderRadius(12)
          .height(24)
          .margin({ top: 8 })
          .onClick(() => {
            this.useCoupon(coupon);
          })
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)
      .padding({ left: 20, right: 12, top: 12, bottom: 12 })
    }
    .width('100%')
    .height(120)
    .backgroundColor($r('app.color.card_background'))
    .borderRadius(8)
    .margin({ bottom: 12 })
    .shadow({
      radius: 4,
      color: 'rgba(0, 0, 0, 0.08)',
      offsetX: 0,
      offsetY: 2
    })
  }

  // ç©ºçŠ¶æ€è§†å›¾
  @Builder
  EmptyView(message: string) {
    Column() {
      // ç©ºçŠ¶æ€å›¾æ ‡
      Column() {
        Text('ğŸ«')
          .fontSize(48)
      }
      .width(80)
      .height(80)
      .justifyContent(FlexAlign.Center)
      .backgroundColor('#F5F5F5')
      .borderRadius(40)

      Text(message)
        .fontSize(14)
        .fontColor($r('app.color.text_hint'))
        .margin({ top: 16 })
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }

  /**
   * è·å–é¡¶éƒ¨å®‰å…¨åŒºåŸŸé«˜åº¦ï¼ˆé¿å¼€èƒ¶å›Šï¼‰
   */
  private getTopSafeHeight(): void {
    try {
      const windowInstance = window.getLastWindow(getContext(this));
      windowInstance.then((win: window.Window) => {
        const avoidArea = win.getWindowAvoidArea(window.AvoidAreaType.TYPE_SYSTEM);
        this.topSafeHeight = px2vp(avoidArea.topRect.height);
        hilog.info(DOMAIN, TAG, 'Top safe height: %{public}d', this.topSafeHeight);
      }).catch((err: Error) => {
        hilog.error(DOMAIN, TAG, 'Failed to get window: %{public}s', err.message);
      });
    } catch (error) {
      hilog.error(DOMAIN, TAG, 'Get top safe height error: %{public}s', JSON.stringify(error));
    }
  }

  /**
   * è§£æè·¯ç”±å‚æ•°
   */
  private parseRouterParams(): void {
    const params = router.getParams() as Record<string, Object>;
    if (params) {
      if (params['themeColor']) {
        this.themeColor = params['themeColor'] as string;
      }
      if (params['isLoggedIn'] !== undefined) {
        this.isLoggedIn = params['isLoggedIn'] as boolean;
      }
    }
  }

  /**
   * åŠ è½½ä¼˜æƒ åˆ¸æ•°æ®
   */
  private async loadCoupons(): Promise<void> {
    // å¦‚æœæœªç™»å½•ï¼Œç›´æ¥æ˜¾ç¤ºç™»å½•æç¤º
    if (!this.isLoggedIn) {
      this.isLoading = false;
      return;
    }

    try {
      const response = await apiService.getCoupons();

      if (response.code === 200 && response.data) {
        const data = response.data as CouponListData;
        this.couponList = data.coupon_list || [];
        this.voucherList = data.voucher_list || [];
        this.couponCount = data.total_coupons || this.couponList.length;
        this.voucherCount = data.total_vouchers || this.voucherList.length;
        hilog.info(DOMAIN, TAG, 'Coupons loaded: %{public}d, Vouchers: %{public}d',
          this.couponCount, this.voucherCount);
      } else {
        hilog.error(DOMAIN, TAG, 'Failed to load coupons: %{public}s', response.msg);
      }
    } catch (error) {
      hilog.error(DOMAIN, TAG, 'Error loading coupons: %{public}s', JSON.stringify(error));
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * æ ¼å¼åŒ–æ—¥æœŸ
   */
  private formatDate(dateStr: string): string {
    if (!dateStr) {
      return '';
    }
    try {
      const date = new Date(dateStr);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    } catch {
      return dateStr;
    }
  }

  /**
   * ä½¿ç”¨ä¼˜æƒ åˆ¸
   */
  private useCoupon(coupon: Coupon): void {
    hilog.info(DOMAIN, TAG, 'Use coupon: %{public}s', coupon.coupon_id);
    // è¿”å›èœå•é¡µå¹¶æºå¸¦ä¼˜æƒ åˆ¸ä¿¡æ¯
    router.back({
      url: 'pages/MenuPage',
      params: {
        selectedCoupon: coupon
      }
    });
  }

  /**
   * åä¸ºIDç™»å½•
   */
  private loginWithHuaweiID(): void {
    const loginRequest = new authentication.HuaweiIDProvider().createLoginWithHuaweiIDRequest();
    loginRequest.forceLogin = true;

    const controller = new authentication.AuthenticationController();
    controller.executeRequest(loginRequest).then(async (data) => {
      const loginResponse = data as authentication.LoginWithHuaweiIDResponse;
      const authCode = loginResponse.data?.authorizationCode;

      hilog.info(DOMAIN, TAG, 'HUAWEI ID auth success');

      if (authCode) {
        try {
          const apiResponse = await apiService.loginWithHuaweiId(authCode);
          if (apiResponse.code === 200 && apiResponse.data) {
            apiService.setToken(apiResponse.data.token);
            this.isLoggedIn = true;
            // ç™»å½•æˆåŠŸåé‡æ–°åŠ è½½ä¼˜æƒ åˆ¸
            this.isLoading = true;
            this.loadCoupons();
            hilog.info(DOMAIN, TAG, 'Login success, reloading coupons');
          }
        } catch (error) {
          hilog.error(DOMAIN, TAG, 'Backend login error: %{public}s', JSON.stringify(error));
        }
      }
    }).catch((error: BusinessError) => {
      hilog.error(DOMAIN, TAG, 'HUAWEI ID login error: %{public}s', JSON.stringify(error));
    });
  }
}
