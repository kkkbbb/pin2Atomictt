import { hilog } from '@kit.PerformanceAnalysisKit';
import { router, window } from '@kit.ArkUI';
import { apiService } from '../services/ApiService';
import {
  appState,
  CartItem,
  CartItemInput,
  CartPackageSelection,
  CartPackageItem,
  CartPolicySelection,
  CartPolicyItem,
  CartCondiment
} from '../services/AppStorage';
import {
  ProductGroup,
  Product,
  OrderType,
  HomeData,
  Order,
  OrderItem,
  OrderFilterType,
  MenuGroup,
  ProductDetail,
  PackageGroup,
  PackageItem,
  PolicyGroupData,
  PolicyGroup,
  PolicyGroupItem,
  CondimentGroupDetail,
  CondimentItemDetail
} from '../models/StoreModels';

const DOMAIN = 0x0000;
const TAG = 'MenuPage';

/**
 * å·²ç¡®è®¤çš„åŠ é€å•†å“é€‰æ‹©
 */
interface ConfirmedPolicySelection {
  item: PolicyGroupItem;
  priceIndex: number;
  priceName: string;
  condiments: Map<string, CondimentSelection>;  // condimentGroupId -> selection
}

interface CondimentSelection {
  groupName: string;
  itemId: string;
  itemName: string;
  price: number;
}

@Entry
@Component
struct MenuPage {
  @State isLoading: boolean = true;
  @State productGroups: ProductGroup[] = [];
  @State allProductGroups: ProductGroup[] = [];  // æ‰€æœ‰åˆ†ç»„ï¼ˆæœªè¿‡æ»¤ï¼‰
  @State menuGroups: MenuGroup[] = [];           // é¡¶çº§èœå•åˆ†ç»„
  @State selectedMenuGroupIndex: number = 0;     // å½“å‰é€‰ä¸­çš„é¡¶çº§åˆ†ç»„
  @State currentShowType: string = '2';          // å½“å‰å±•ç¤ºç±»å‹: "1"=å°å›¾ "2"=å¤§å›¾
  @State selectedGroupIndex: number = 0;
  @State orderType: OrderType = OrderType.PICKUP;
  @State themeColor: string = '#FFD700';
  @State currencySymbol: string = '$';

  // åº—é“ºä¿¡æ¯çŠ¶æ€
  @State storeName: string = '';
  @State storeImage: string = '';
  @State storeStatus: string = '';
  @State todayStatus: string = '';
  @State isOpen: boolean = true;
  @State notices: string[] = [];
  @State currentTab: number = 1; // 0=ä¸»é , 1=é»é¤, 2=æ­·å²è¨‚å–®
  @State currentLang: string = 'ç¹';
  @State showNoticeExpand: boolean = false;
  @State topSafeHeight: number = 0; // é¡¶éƒ¨å®‰å…¨è·ç¦»ï¼ˆé¿å¼€èƒ¶å›Šï¼‰

  // è®¢å•ç›¸å…³çŠ¶æ€
  @State orders: Order[] = [];
  @State orderTotal: number = 0;
  @State orderFilterType: OrderFilterType = OrderFilterType.ALL;
  @State isOrderLoading: boolean = false;
  @State orderPageNumber: number = 1;
  @State showFilterDropdown: boolean = false;
  @State hasMoreOrders: boolean = true;

  // äº§å“è¯¦æƒ…å¼¹çª—ç›¸å…³çŠ¶æ€
  @State showProductDetail: boolean = false;
  @State selectedProduct: ProductDetail | null = null;
  @State isDetailLoading: boolean = false;
  @State selectedPriceIndex: number = 0;              // é€‰ä¸­çš„è§„æ ¼ç´¢å¼•
  @State selectedPackageItems: Map<string, Set<string>> = new Map();  // é…æ–™é€‰æ‹©: groupId -> Set<productId>
  @State quantity: number = 1;                         // è´­ä¹°æ•°é‡
  @State policyGroups: PolicyGroup[] = [];            // åŠ é€é€‰æ‹©æ•°æ®ï¼ˆæ¥è‡ªpolicy APIï¼‰
  // åŠ é€å•†å“é…æ–™é€‰æ‹©å¼¹çª—çŠ¶æ€
  @State showCondimentSheet: boolean = false;         // æ˜¯å¦æ˜¾ç¤ºé…æ–™é€‰æ‹©å¼¹çª—
  @State selectedPolicyItem: PolicyGroupItem | null = null;  // å½“å‰é€‰ä¸­çš„åŠ é€å•†å“
  @State selectedPolicyGroupId: string = '';          // å½“å‰é€‰ä¸­çš„åŠ é€ç»„ID
  @State selectedCondimentItems: Map<string, string> = new Map();  // é…æ–™é€‰æ‹©: condimentGroupId -> condimentItemId
  @State selectedPolicyPriceIndex: number = 0;        // åŠ é€å•†å“çš„è§„æ ¼é€‰æ‹©ç´¢å¼•ï¼ˆpricesæ•°ç»„ï¼‰
  // ä¿å­˜å·²ç¡®è®¤çš„åŠ é€å•†å“é€‰æ‹©ï¼ˆåŒ…æ‹¬è§„æ ¼å’Œé…æ–™ï¼‰: groupId -> { item, priceIndex, condiments }
  @State confirmedPolicySelections: Map<string, ConfirmedPolicySelection> = new Map();
  // ä¸»å•†å“é…æ–™é€‰æ‹©ï¼ˆç”œåº¦ã€å†°é‡ç­‰ï¼‰: condimentGroupId -> condimentItemId
  @State selectedProductCondiments: Map<string, string> = new Map();

  // è´­ç‰©è½¦çŠ¶æ€
  @State cartCount: number = 0;                       // è´­ç‰©è½¦å•†å“æ•°é‡
  @State cartTotal: number = 0;                       // è´­ç‰©è½¦æ€»ä»·
  @State showCartPopup: boolean = false;              // è´­ç‰©è½¦å¼¹çª—æ˜¯å¦æ˜¾ç¤º

  private detailScroller: Scroller = new Scroller();

  private scroller: Scroller = new Scroller();
  private categoryScroller: Scroller = new Scroller();
  private orderScroller: Scroller = new Scroller();

  build() {
    Stack() {
      // ä¸»å†…å®¹å±‚
      Column() {
        // é¡¶éƒ¨åº—é“ºä¿¡æ¯åŒºåŸŸï¼ˆåŒ…å«å®‰å…¨è·ç¦»ï¼‰
        this.StoreHeader()

        // å…¬å‘Šæ 
        if (this.notices.length > 0) {
          this.NoticeBar()
        }

        // Tab å¯¼èˆª + æœåŠ¡ç±»å‹ + è¯­è¨€åˆ‡æ¢
        this.TabBar()

        // é¡¶çº§èœå•åˆ†ç»„å¯¼èˆªæ¡ï¼ˆä»…åœ¨ç‚¹é¤Tabä¸”æœ‰å¤šä¸ªåˆ†ç±»æ—¶æ˜¾ç¤ºï¼‰
        if (this.currentTab === 1 && this.shouldShowMenuGroupBar()) {
          this.MenuGroupBar()
        }

        // æ ¹æ®å½“å‰Tabæ˜¾ç¤ºä¸åŒå†…å®¹
        if (this.currentTab === 2) {
          // å†å²è®¢å•
          this.OrderHistoryView()
        } else if (this.isLoading) {
          this.LoadingView()
        } else {
          Row() {
            // å·¦ä¾§åˆ†ç±»åˆ—è¡¨
            this.CategoryList()

            // å³ä¾§äº§å“åˆ—è¡¨
            this.ProductList()
          }
          .layoutWeight(1)
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F5F5F5')

      // è´­ç‰©è½¦å¼¹çª—ï¼ˆåœ¨æ‚¬æµ®æ ä¸‹å±‚ï¼‰
      if (this.showCartPopup && this.currentTab === 1) {
        this.CartPopup()
      }

      // è´­ç‰©è½¦æ‚¬æµ®æ ï¼ˆä»…åœ¨ç‚¹é¤Tabä¸”æœ‰å•†å“æ—¶æ˜¾ç¤ºï¼Œå§‹ç»ˆåœ¨æœ€ä¸Šå±‚ï¼‰
      if (this.currentTab === 1 && this.cartCount > 0) {
        this.CartBottomBar()
      }

      // äº§å“è¯¦æƒ…å¼¹çª—å±‚
      if (this.showProductDetail) {
        this.ProductDetailSheet()
      }
    }
    .width('100%')
    .height('100%')
  }

  // åº—é“ºå¤´éƒ¨ä¿¡æ¯ï¼ˆåŒ…å«é¡¶éƒ¨å®‰å…¨è·ç¦»ï¼‰
  @Builder
  StoreHeader() {
    Stack() {
      // èƒŒæ™¯å±‚ - åº—é“ºå›¾ç‰‡æ¯›ç»ç’ƒæ•ˆæœ
      Column() {
        if (this.storeImage) {
          Image(this.storeImage)
            .width('100%')
            .height('100%')
            .objectFit(ImageFit.Cover)
            .blur(20)
            .opacity(0.6)
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#DBD7D8')

      // å†…å®¹å±‚
      Column() {
        Row() {
          // è¿”å›æŒ‰é’®
          Text('â€¹')
            .width(32)
            .height(32)
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor($r('app.color.text_primary'))
            .textAlign(TextAlign.Center)
            .margin({ left: 8, top: 12 })
            .onClick(() => {
              router.back();
            })

          // åº—é“ºå›¾ç‰‡
          Column() {
            if (this.storeImage) {
              Image(this.storeImage)
                .width(80)
                .height(80)
                .borderRadius(10)
                .objectFit(ImageFit.Cover)
                .shadow({
                  radius: 6,
                  color: 'rgba(0, 0, 0, 0.15)',
                  offsetX: 0,
                  offsetY: 3
                })
            } else {
              Image($r('app.media.startIcon'))
                .width(80)
                .height(80)
                .borderRadius(10)
                .objectFit(ImageFit.Cover)
                .shadow({
                  radius: 6,
                  color: 'rgba(0, 0, 0, 0.15)',
                  offsetX: 0,
                  offsetY: 3
                })
            }
          }
          .margin({ left: 8, top: 12 })

          // åº—é“ºä¿¡æ¯
          Column() {
            // åº—é“ºåç§°
            Text(this.storeName)
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })

            // çŠ¶æ€æ ‡ç­¾è¡Œ
            Row() {
              // å•†å®¶çŠ¶æ€æ ‡ç­¾
              if (this.storeStatus) {
                Text(this.storeStatus)
                  .fontSize(11)
                  .fontColor('#666666')
                  .backgroundColor('#EEEEEE')
                  .borderRadius(3)
                  .padding({ left: 6, right: 6, top: 2, bottom: 2 })
              }

              // ä»Šæ—¥çŠ¶æ€æ ‡ç­¾
              if (this.todayStatus) {
                Text(this.todayStatus)
                  .fontSize(11)
                  .fontColor('#666666')
                  .backgroundColor('#EEEEEE')
                  .borderRadius(3)
                  .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                  .margin({ left: 6 })
              }

              // å…³äºå•†æˆ·æŒ‰é’®
              Row() {
                Text('é—œæ–¼å•†æˆ¶')
                  .fontSize(11)
                  .fontColor('#666666')
                Text(' â“˜')
                  .fontSize(10)
                  .fontColor('#999999')
              }
              .backgroundColor('#FFFFFF')
              .borderRadius(3)
              .padding({ left: 6, right: 6, top: 2, bottom: 2 })
              .border({ width: 0.5, color: '#DDDDDD' })
              .margin({ left: 6 })
              .onClick(() => {
                this.showStoreInfo();
              })
            }
            .margin({ top: 6 })
          }
          .alignItems(HorizontalAlign.Start)
          .margin({ left: 12, top: 16 })
          .layoutWeight(1)
        }
        .width('100%')
        .alignItems(VerticalAlign.Top)
      }
      .width('100%')
      .padding({ top: this.topSafeHeight + 8, bottom: 12 })
    }
    .width('100%')
    .height(this.topSafeHeight + 120)
  }

  // å…¬å‘Šæ 
  @Builder
  NoticeBar() {
    Row() {
      // å…¬å‘Šæ ‡ç­¾
      Text('å…¬å‘Š:')
        .fontSize(13)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')
        .margin({ left: 12 })

      // å…¬å‘Šå†…å®¹
      Text(this.notices.join(' | '))
        .fontSize(13)
        .fontColor('#666666')
        .maxLines(this.showNoticeExpand ? 10 : 1)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
        .layoutWeight(1)
        .margin({ left: 6, right: 8 })

      // å±•å¼€ç®­å¤´
      Text(this.showNoticeExpand ? 'â–²' : 'â–¼')
        .fontSize(10)
        .fontColor('#999999')
        .margin({ right: 12 })
        .onClick(() => {
          this.showNoticeExpand = !this.showNoticeExpand;
        })
    }
    .width('100%')
    .padding({ top: 8, bottom: 8 })
    .backgroundColor('#FFFACD')
    .alignItems(VerticalAlign.Center)
  }

  // é¡¶çº§èœå•åˆ†ç»„æ¨ªå‘å¯¼èˆªæ¡
  @Builder
  MenuGroupBar() {
    Scroll() {
      Row({ space: 10 }) {
        ForEach(this.menuGroups, (menuGroup: MenuGroup, index: number) => {
          Text(menuGroup.local_name)
            .fontSize(14)
            .fontWeight(this.selectedMenuGroupIndex === index ? FontWeight.Medium : FontWeight.Normal)
            .fontColor(this.selectedMenuGroupIndex === index ? '#333333' : '#666666')
            .backgroundColor(this.selectedMenuGroupIndex === index ? this.themeColor : '#FFFFFF')
            .borderRadius(16)
            .border({
              width: 1,
              color: this.themeColor
            })
            .padding({ left: 16, right: 16, top: 8, bottom: 8 })
            .opacity(menuGroup.can_order === 1 ? 1 : 0.6)
            .onClick(() => {
              this.onMenuGroupSelect(index);
            })
        })
      }
      .padding({ left: 12, right: 12 })
      .justifyContent(FlexAlign.Start)
    }
    .scrollable(ScrollDirection.Horizontal)
    .scrollBar(BarState.Off)
    .align(Alignment.Start)
    .width('100%')
    .height(48)
    .backgroundColor('#FFFFFF')
  }

  /**
   * åˆ¤æ–­æ˜¯å¦æ˜¾ç¤ºé¡¶çº§åˆ†ç±»å¯¼èˆªæ¡
   */
  private shouldShowMenuGroupBar(): boolean {
    // æ²¡æœ‰åˆ†ç±»æˆ–åªæœ‰ä¸€ä¸ªåˆ†ç±»æ—¶ä¸æ˜¾ç¤º
    return this.menuGroups.length > 1;
  }

  // Tab å¯¼èˆªæ  + æœåŠ¡ç±»å‹ + è¯­è¨€åˆ‡æ¢ï¼ˆåˆå¹¶ä¸ºä¸€è¡Œï¼‰
  @Builder
  TabBar() {
    Row() {
      // å·¦ä¾§ï¼šTab å¯¼èˆªï¼ˆå·¦å¯¹é½ï¼‰
      Row() {
        // ä¸»é  Tab
        Column() {
          Text('ä¸»é ')
            .fontSize(15)
            .fontColor(this.currentTab === 0 ? '#333333' : '#999999')
            .fontWeight(this.currentTab === 0 ? FontWeight.Medium : FontWeight.Normal)
          if (this.currentTab === 0) {
            Column()
              .width(24)
              .height(2)
              .backgroundColor(this.themeColor)
              .borderRadius(1)
              .margin({ top: 4 })
          }
        }
        .height(44)
        .padding({ left: 12, right: 12 })
        .justifyContent(FlexAlign.Center)
        .onClick(() => {
          router.back();
        })

        // é»é¤ Tab
        Column() {
          Text('é»é¤')
            .fontSize(15)
            .fontColor(this.currentTab === 1 ? '#333333' : '#999999')
            .fontWeight(this.currentTab === 1 ? FontWeight.Medium : FontWeight.Normal)
          if (this.currentTab === 1) {
            Column()
              .width(24)
              .height(2)
              .backgroundColor(this.themeColor)
              .borderRadius(1)
              .margin({ top: 4 })
          }
        }
        .height(44)
        .padding({ left: 12, right: 12 })
        .justifyContent(FlexAlign.Center)
        .onClick(() => {
          this.currentTab = 1;
          // å¦‚æœèœå•è¿˜æœªåŠ è½½ï¼Œåˆ™åŠ è½½
          if (this.productGroups.length === 0 && !this.isLoading) {
            this.loadMenuData();
          }
        })

        // æ­·å²è¨‚å–® Tab
        Column() {
          Text('æ­·å²è¨‚å–®')
            .fontSize(15)
            .fontColor(this.currentTab === 2 ? '#333333' : '#999999')
            .fontWeight(this.currentTab === 2 ? FontWeight.Medium : FontWeight.Normal)
          if (this.currentTab === 2) {
            Column()
              .width(42)
              .height(2)
              .backgroundColor(this.themeColor)
              .borderRadius(1)
              .margin({ top: 4 })
          }
        }
        .height(44)
        .padding({ left: 12, right: 12 })
        .justifyContent(FlexAlign.Center)
        .onClick(() => {
          this.currentTab = 2;
          hilog.info(DOMAIN, TAG, 'Navigate to order history');
          this.loadOrders();
        })
      }

      Blank()

      // å³ä¾§ï¼šå¤–å–è‡ªå– + è¯­è¨€åˆ‡æ¢ï¼ˆåŒ¹é…H5æ ·å¼ï¼‰
      Row() {
        // å¤–å–è‡ªå–æŒ‰é’®ï¼ˆå›¾æ ‡+æ–‡å­—å‚ç›´å¸ƒå±€ï¼‰
        Column() {
          // ä½¿ç”¨æ–‡å­—å›¾æ ‡ï¼ˆç›’å­ç¬¦å·ï¼‰
          Text('ğŸ“¦')
            .fontSize(16)
          Text(this.orderType === OrderType.PICKUP ? 'å¤–è³£è‡ªå–' : 'å ‚é£Ÿ')
            .fontSize(9)
            .fontColor('#666666')
            .margin({ top: 2 })
        }
        .width(50)
        .height(44)
        .justifyContent(FlexAlign.Center)
        .onClick(() => {
          hilog.info(DOMAIN, TAG, 'Order type: %{public}s',
            this.orderType === OrderType.PICKUP ? 'å¤–è³£è‡ªå–' : 'å ‚é£Ÿ');
        })

        // è¯­è¨€åˆ‡æ¢æŒ‰é’®ï¼ˆæ–‡å­—+Languageå‚ç›´å¸ƒå±€ï¼‰
        Column() {
          Text(this.currentLang)
            .fontSize(15)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333333')
          Text('Language')
            .fontSize(8)
            .fontColor('#999999')
            .margin({ top: 1 })
        }
        .width(50)
        .height(44)
        .justifyContent(FlexAlign.Center)
        .onClick(() => {
          this.currentLang = this.currentLang === 'ç¹' ? 'ç®€' : 'ç¹';
          hilog.info(DOMAIN, TAG, 'Switch language to: %{public}s', this.currentLang);
        })
      }
      .padding({ right: 4 })
    }
    .width('100%')
    .height(46)
    .backgroundColor('#FFFFFF')
    .alignItems(VerticalAlign.Center)
    .border({ width: { bottom: 0.5 }, color: '#E5E5E5' })
  }

  // åŠ è½½ä¸­
  @Builder
  LoadingView() {
    Column() {
      LoadingProgress()
        .width(50)
        .height(50)
        .color(this.themeColor)
      Text('è¼‰å…¥èœå–®ä¸­...')
        .fontSize(13)
        .fontColor('#999999')
        .margin({ top: 12 })
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }

  // å·¦ä¾§åˆ†ç±»åˆ—è¡¨
  @Builder
  CategoryList() {
    List({ scroller: this.categoryScroller }) {
      ForEach(this.productGroups, (group: ProductGroup, index: number) => {
        ListItem() {
          Row() {
            // é€‰ä¸­æŒ‡ç¤ºæ¡
            if (this.selectedGroupIndex === index) {
              Column()
                .width(3)
                .height(18)
                .backgroundColor(this.themeColor)
                .borderRadius(1.5)
            }
            Text(group.local_name)
              .fontSize(13)
              .fontColor(this.selectedGroupIndex === index ? '#333333' : '#666666')
              .fontWeight(this.selectedGroupIndex === index ? FontWeight.Medium : FontWeight.Normal)
              .maxLines(2)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .textAlign(TextAlign.Start)
              .layoutWeight(1)
              .margin({ left: this.selectedGroupIndex === index ? 6 : 9 })
          }
          .width('100%')
          .height(48)
          .alignItems(VerticalAlign.Center)
          .padding({ right: 6 })
          .backgroundColor(this.selectedGroupIndex === index ? '#FFFFFF' : 'transparent')
          .onClick(() => {
            this.selectedGroupIndex = index;
            // æ»šåŠ¨åˆ°å¯¹åº”åˆ†ç»„
            this.scroller.scrollToIndex(this.getProductListIndexForGroup(index));
          })
        }
      })

      // åº•éƒ¨å ä½ï¼Œä¸ºè´­ç‰©è½¦æ‚¬æµ®å¡ç‰‡ç•™å‡ºç©ºé—´
      if (this.cartCount > 0) {
        ListItem() {
          Column()
            .width('100%')
            .height(66)
        }
      }
    }
    .width(85)
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  // å³ä¾§äº§å“åˆ—è¡¨
  @Builder
  ProductList() {
    List({ scroller: this.scroller }) {
      ForEach(this.productGroups, (group: ProductGroup, groupIndex: number) => {
        // åˆ†ç»„æ ‡é¢˜
        ListItem() {
          Row() {
            Text(group.local_name)
              .fontSize(15)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333333')

            Blank()

            // ä¾›åº”æ—¶é—´ï¼ˆå³å¯¹é½ï¼Œç°è‰²å°å­—ï¼‰
            Text(group.time_range ? `ä¾›æ‡‰æ™‚é–“${group.time_range}` : 'ä¾›æ‡‰æ™‚é–“-')
              .fontSize(11)
              .fontColor('#999999')
          }
          .width('100%')
          .padding({ left: 10, right: 10, top: 14, bottom: 6 })
        }

        // äº§å“åˆ—è¡¨
        ForEach(group.products, (product: Product) => {
          ListItem() {
            if (this.currentShowType === '2') {
              this.ProductItemLarge(product)
            } else {
              this.ProductItemSmall(product)
            }
          }
        })
      })

      // åº•éƒ¨å ä½ï¼Œä¸ºè´­ç‰©è½¦æ‚¬æµ®å¡ç‰‡ç•™å‡ºç©ºé—´
      if (this.cartCount > 0) {
        ListItem() {
          Column()
            .width('100%')
            .height(66)
        }
      }
    }
    .layoutWeight(1)
    .height('100%')
    .backgroundColor('#F5F5F5')
    .onScrollIndex((firstIndex: number) => {
      // æ›´æ–°é€‰ä¸­çš„åˆ†ç±»
      let currentGroup = 0;
      let itemCount = 0;
      for (let i = 0; i < this.productGroups.length; i++) {
        if (firstIndex <= itemCount) {
          currentGroup = i;
          break;
        }
        itemCount += this.productGroups[i].products.length + 1;
        currentGroup = i;
      }
      if (this.selectedGroupIndex !== currentGroup) {
        this.selectedGroupIndex = currentGroup;
        // åŒæ­¥æ»šåŠ¨å·¦ä¾§åˆ†ç±»åˆ—è¡¨
        this.categoryScroller.scrollToIndex(currentGroup);
      }
    })
  }

  // äº§å“é¡¹ - å¤§å›¾æ¨¡å¼ (show_type = "2")
  @Builder
  ProductItemLarge(product: Product) {
    Column() {
      // äº§å“å›¾ç‰‡ï¼ˆå¤§å›¾ï¼Œå®½åº¦å¡«æ»¡ï¼‰
      if (product.cover_image) {
        Image(product.cover_image)
          .width('100%')
          .height(180)
          .borderRadius({ topLeft: 8, topRight: 8 })
          .objectFit(ImageFit.Cover)
      } else {
        Column()
          .width('100%')
          .height(180)
          .borderRadius({ topLeft: 8, topRight: 8 })
          .backgroundColor('#EEEEEE')
      }

      // äº§å“ä¿¡æ¯åŒºåŸŸ
      Column() {
        // äº§å“åç§° + é»é¸æŒ‰é’®
        Row() {
          Text(product.local_name)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .layoutWeight(1)

          // é»é¸æŒ‰é’®
          Text('é»é¸')
            .fontSize(13)
            .fontColor('#666666')
            .backgroundColor('#FFFFFF')
            .borderRadius(14)
            .border({ width: 1, color: '#E5E5E5' })
            .padding({ left: 14, right: 14, top: 6, bottom: 6 })
            .onClick(() => {
              this.openProductDetail(product);
            })
        }
        .width('100%')
        .alignItems(VerticalAlign.Center)

        // äº§å“æè¿°/æ ‡ç­¾
        if (product.description?.local_description) {
          Text(product.description.local_description)
            .fontSize(12)
            .fontColor('#999999')
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .margin({ top: 6 })
        }

        // ä»·æ ¼
        Row() {
          Text(this.currencySymbol)
            .fontSize(14)
            .fontColor('#C4A000')
          Text(this.getPrice(product))
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#C4A000')
          if (this.hasMultipleSpecs(product)) {
            Text('èµ·')
              .fontSize(12)
              .fontColor('#C4A000')
              .margin({ left: 2 })
          }
        }
        .margin({ top: 8 })
        .alignItems(VerticalAlign.Bottom)
      }
      .width('100%')
      .padding(12)
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .backgroundColor('#FFFFFF')
    .borderRadius(8)
    .margin({ top: 8, left: 8, right: 8 })
    .onClick(() => {
      this.openProductDetail(product);
    })
  }

  // äº§å“é¡¹ - å°å›¾æ¨¡å¼ (show_type = "1")
  @Builder
  ProductItemSmall(product: Product) {
    Row() {
      // äº§å“å›¾ç‰‡ï¼ˆå°å›¾ï¼‰
      if (product.cover_image) {
        Image(product.cover_image)
          .width(70)
          .height(70)
          .borderRadius(6)
          .objectFit(ImageFit.Cover)
      } else {
        Column()
          .width(70)
          .height(70)
          .borderRadius(6)
          .backgroundColor('#EEEEEE')
      }

      // äº§å“ä¿¡æ¯
      Column() {
        // äº§å“åç§°
        Text(product.local_name)
          .fontSize(15)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        Blank()

        // ä»·æ ¼è¡Œ
        Row() {
          Text(this.currencySymbol)
            .fontSize(13)
            .fontColor('#C4A000')
          Text(this.getPrice(product))
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#C4A000')
          if (this.hasMultipleSpecs(product)) {
            Text(' èµ·')
              .fontSize(11)
              .fontColor('#C4A000')
          }
        }
        .alignItems(VerticalAlign.Bottom)
      }
      .layoutWeight(1)
      .height(70)
      .alignItems(HorizontalAlign.Start)
      .justifyContent(FlexAlign.SpaceBetween)
      .margin({ left: 12 })

      // é»é¸æŒ‰é’®
      Text('é»é¸')
        .fontSize(13)
        .fontColor('#666666')
        .backgroundColor('#FFFFFF')
        .borderRadius(14)
        .border({ width: 1, color: '#E5E5E5' })
        .padding({ left: 12, right: 12, top: 5, bottom: 5 })
        .onClick(() => {
          this.openProductDetail(product);
        })
    }
    .width('100%')
    .padding(10)
    .backgroundColor('#FFFFFF')
    .borderRadius(8)
    .margin({ top: 6, left: 8, right: 8 })
    .alignItems(VerticalAlign.Center)
    .onClick(() => {
      this.openProductDetail(product);
    })
  }

  // ==================== å†å²è®¢å•ç›¸å…³ç»„ä»¶ ====================

  // å†å²è®¢å•ä¸»è§†å›¾
  @Builder
  OrderHistoryView() {
    Column() {
      // ç­›é€‰æ 
      this.OrderFilterBar()

      if (this.isOrderLoading && this.orders.length === 0) {
        // åˆæ¬¡åŠ è½½ä¸­
        this.OrderLoadingView()
      } else if (this.orders.length === 0) {
        // ç©ºçŠ¶æ€
        this.OrderEmptyView()
      } else {
        // è®¢å•åˆ—è¡¨
        this.OrderListView()
      }
    }
    .width('100%')
    .layoutWeight(1)
    .backgroundColor('#F5F5F5')
  }

  // è®¢å•ç­›é€‰æ 
  @Builder
  OrderFilterBar() {
    Row() {
      Blank()

      // ç­›é€‰ä¸‹æ‹‰æ¡†
      Row() {
        Text(this.getFilterLabel())
          .fontSize(14)
          .fontColor('#333333')
        Text(' â–¼')
          .fontSize(10)
          .fontColor('#666666')
      }
      .padding({ left: 12, right: 12, top: 8, bottom: 8 })
      .backgroundColor('#FFFFFF')
      .borderRadius(4)
      .border({ width: 0.5, color: '#E5E5E5' })
      .onClick(() => {
        this.showFilterDropdown = !this.showFilterDropdown;
      })
      .bindMenu(this.showFilterDropdown, [
        {
          value: 'å…¨éƒ¨è¨‚å–®',
          action: () => {
            this.onFilterChange(OrderFilterType.ALL);
          }
        },
        {
          value: 'é€²è¡Œä¸­',
          action: () => {
            this.onFilterChange(OrderFilterType.IN_PROGRESS);
          }
        },
        {
          value: 'å·²å®Œæˆ',
          action: () => {
            this.onFilterChange(OrderFilterType.COMPLETED);
          }
        },
        {
          value: 'é€€æ¬¾/å–æ¶ˆ',
          action: () => {
            this.onFilterChange(OrderFilterType.REFUND);
          }
        }
      ])
    }
    .width('100%')
    .height(48)
    .padding({ left: 12, right: 12 })
    .alignItems(VerticalAlign.Center)
    .backgroundColor('#FFFFFF')
    .border({ width: { bottom: 0.5 }, color: '#E5E5E5' })
  }

  // è®¢å•åŠ è½½ä¸­
  @Builder
  OrderLoadingView() {
    Column() {
      LoadingProgress()
        .width(50)
        .height(50)
        .color(this.themeColor)
      Text('è¼‰å…¥è¨‚å–®ä¸­...')
        .fontSize(13)
        .fontColor('#999999')
        .margin({ top: 12 })
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }

  // è®¢å•ç©ºçŠ¶æ€
  @Builder
  OrderEmptyView() {
    Column() {
      Text('ğŸ“‹')
        .fontSize(60)
        .margin({ bottom: 16 })

      Text('æš«ç„¡è¨‚å–®')
        .fontSize(16)
        .fontColor('#999999')
        .margin({ bottom: 24 })

      // ç™»å½•/æ³¨å†ŒæŒ‰é’®ï¼ˆæœªç™»å½•æ—¶æ˜¾ç¤ºï¼‰
      Button('ç™»å…¥/è¨»å†Š')
        .width(140)
        .height(44)
        .fontSize(15)
        .fontColor('#333333')
        .backgroundColor(this.themeColor)
        .borderRadius(22)
        .onClick(() => {
          hilog.info(DOMAIN, TAG, 'Navigate to login');
          // TODO: è·³è½¬åˆ°ç™»å½•é¡µé¢
        })
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }

  // è®¢å•åˆ—è¡¨
  @Builder
  OrderListView() {
    List({ scroller: this.orderScroller }) {
      ForEach(this.orders, (order: Order) => {
        ListItem() {
          this.OrderCard(order)
        }
      })

      // åŠ è½½æ›´å¤š
      if (this.hasMoreOrders) {
        ListItem() {
          Row() {
            if (this.isOrderLoading) {
              LoadingProgress()
                .width(24)
                .height(24)
                .color(this.themeColor)
              Text('è¼‰å…¥æ›´å¤š...')
                .fontSize(13)
                .fontColor('#999999')
                .margin({ left: 8 })
            } else {
              Text('ä¸Šæ‹‰åŠ è¼‰æ›´å¤š')
                .fontSize(13)
                .fontColor('#999999')
            }
          }
          .width('100%')
          .height(50)
          .justifyContent(FlexAlign.Center)
        }
      }
    }
    .width('100%')
    .layoutWeight(1)
    .padding({ top: 8, bottom: 8 })
    .onReachEnd(() => {
      if (this.hasMoreOrders && !this.isOrderLoading) {
        this.loadMoreOrders();
      }
    })
  }

  // è®¢å•å¡ç‰‡
  @Builder
  OrderCard(order: Order) {
    Column() {
      // é¡¶éƒ¨ï¼šè®¢å•å· + çŠ¶æ€
      Row() {
        Text(`è¨‚å–®è™Ÿ: ${order.order_no}`)
          .fontSize(13)
          .fontColor('#666666')

        Blank()

        // çŠ¶æ€æ ‡ç­¾
        Text(this.getStatusText(order.status))
          .fontSize(12)
          .fontColor(this.getStatusColor(order.status))
          .backgroundColor(this.getStatusBgColor(order.status))
          .borderRadius(4)
          .padding({ left: 8, right: 8, top: 3, bottom: 3 })
      }
      .width('100%')
      .margin({ bottom: 12 })

      // è®¢å•ç±»å‹ + æ—¶é—´
      Row() {
        Text(order.order_type === 1 ? 'å¤–è³£è‡ªå–' : 'å ‚é£Ÿ')
          .fontSize(12)
          .fontColor('#999999')

        Text(' | ')
          .fontSize(12)
          .fontColor('#E5E5E5')

        Text(order.created_at)
          .fontSize(12)
          .fontColor('#999999')
      }
      .margin({ bottom: 12 })

      // å•†å“åˆ—è¡¨ï¼ˆæœ€å¤šæ˜¾ç¤º3ä¸ªï¼‰
      ForEach(order.items.slice(0, 3), (item: OrderItem) => {
        Row() {
          // å•†å“å›¾ç‰‡
          if (item.cover_image) {
            Image(item.cover_image)
              .width(50)
              .height(50)
              .borderRadius(4)
              .objectFit(ImageFit.Cover)
          } else {
            Column()
              .width(50)
              .height(50)
              .borderRadius(4)
              .backgroundColor('#EEEEEE')
          }

          // å•†å“ä¿¡æ¯
          Column() {
            Text(item.local_name)
              .fontSize(14)
              .fontColor('#333333')
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })

            if (item.specifications) {
              Text(item.specifications)
                .fontSize(12)
                .fontColor('#999999')
                .maxLines(1)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
                .margin({ top: 4 })
            }
          }
          .alignItems(HorizontalAlign.Start)
          .layoutWeight(1)
          .margin({ left: 10 })

          // æ•°é‡
          Text(`x${item.quantity}`)
            .fontSize(13)
            .fontColor('#666666')
        }
        .width('100%')
        .margin({ bottom: 8 })
      })

      // å¦‚æœå•†å“è¶…è¿‡3ä¸ªï¼Œæ˜¾ç¤ºæ›´å¤šæç¤º
      if (order.items.length > 3) {
        Text(`...å…±${order.items.length}ä»¶å•†å“`)
          .fontSize(12)
          .fontColor('#999999')
          .margin({ bottom: 8 })
      }

      // åˆ†éš”çº¿
      Divider()
        .strokeWidth(0.5)
        .color('#E5E5E5')
        .margin({ top: 8, bottom: 12 })

      // åº•éƒ¨ï¼šé‡‘é¢ + æ“ä½œæŒ‰é’®
      Row() {
        // é‡‘é¢
        Row() {
          Text('åˆè¨ˆ: ')
            .fontSize(14)
            .fontColor('#666666')
          Text(this.currencySymbol)
            .fontSize(12)
            .fontColor('#333333')
          Text(order.pay_amount)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
        }

        Blank()

        // å†æ¥ä¸€å•æŒ‰é’®
        Button('å†ä¾†ä¸€å–®')
          .height(32)
          .fontSize(13)
          .fontColor('#333333')
          .backgroundColor(this.themeColor)
          .borderRadius(16)
          .padding({ left: 16, right: 16 })
          .onClick(() => {
            this.reorder(order);
          })
      }
      .width('100%')
    }
    .width('100%')
    .padding(12)
    .backgroundColor('#FFFFFF')
    .borderRadius(8)
    .margin({ left: 12, right: 12, bottom: 10 })
  }

  // ==================== äº§å“è¯¦æƒ…å¼¹çª—ç»„ä»¶ ====================

  // äº§å“è¯¦æƒ…å¼¹çª—
  @Builder
  ProductDetailSheet() {
    Stack({ alignContent: Alignment.Bottom }) {
      // é®ç½©å±‚
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.5)')
        .onClick(() => {
          this.closeProductDetail();
        })

      // å¼¹çª—å†…å®¹ï¼ˆä»åº•éƒ¨å¼¹å‡ºï¼Œé«˜åº¦è‡ªé€‚åº”ï¼‰
      Column() {
        // é¡¶éƒ¨æ ‡é¢˜æ 
        Row() {
          Text('â€¹')
            .width(40)
            .height(44)
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
            .textAlign(TextAlign.Center)
            .onClick(() => {
              this.closeProductDetail();
            })

          Text('é¸æ“‡é¤å“')
            .fontSize(17)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333333')
            .layoutWeight(1)
            .textAlign(TextAlign.Center)

          Column()
            .width(40)
            .height(44)
        }
        .width('100%')
        .height(44)
        .padding({ left: 4, right: 4 })
        .backgroundColor('#FFFFFF')
        .border({ width: { bottom: 0.5 }, color: '#E5E5E5' })

        if (this.isDetailLoading) {
          // åŠ è½½ä¸­
          Column() {
            LoadingProgress()
              .width(50)
              .height(50)
              .color(this.themeColor)
            Text('è¼‰å…¥ä¸­...')
              .fontSize(13)
              .fontColor('#999999')
              .margin({ top: 12 })
          }
          .width('100%')
          .height(150)
          .justifyContent(FlexAlign.Center)
        } else if (this.selectedProduct) {
          // äº§å“è¯¦æƒ…å†…å®¹ - ç›´æ¥å†…è”
          Scroll(this.detailScroller) {
            Column() {
              // äº§å“å›¾ç‰‡
              if (this.selectedProduct.cover_image) {
                Image(this.selectedProduct.cover_image)
                  .width('100%')
                  .height(220)
                  .objectFit(ImageFit.Cover)
              }

              // äº§å“åç§°
              Text(this.selectedProduct.local_name)
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .fontColor('#333333')
                .width('100%')
                .padding({ left: 16, right: 16, top: 16, bottom: 8 })

              // äº§å“æè¿°
              if (this.selectedProduct.description?.local_description) {
                Text(this.selectedProduct.description.local_description)
                  .fontSize(13)
                  .fontColor('#666666')
                  .width('100%')
                  .padding({ left: 16, right: 16, bottom: 12 })
              }

              // è§„æ ¼é€‰æ‹©ï¼ˆå¤šä¸ªä»·æ ¼è§„æ ¼æ—¶æ˜¾ç¤ºï¼‰
              if (this.selectedProduct.prices && this.selectedProduct.prices.length > 1) {
                this.PriceSpecSection(this.selectedProduct)
              }

              // ä¸»å•†å“é…æ–™é€‰æ‹©ï¼ˆç”œåº¦ã€å†°é‡ç­‰ï¼‰
              if (this.selectedProduct.condiment_group && this.selectedProduct.condiment_group.length > 0) {
                ForEach(this.selectedProduct.condiment_group as CondimentGroupDetail[], (group: CondimentGroupDetail) => {
                  this.ProductCondimentGroupSection(group)
                })
              }

              // é…æ–™é€‰æ‹©ç»„ï¼ˆpackageGroupsï¼‰
              if (this.selectedProduct.packageGroups && this.selectedProduct.packageGroups.length > 0) {
                ForEach(this.selectedProduct.packageGroups, (group: PackageGroup) => {
                  this.PackageGroupSection(group)
                })
              }

              // åŠ é€é€‰æ‹©ç»„ï¼ˆpolicyGroupsï¼‰
              if (this.policyGroups && this.policyGroups.length > 0) {
                ForEach(this.policyGroups, (group: PolicyGroup) => {
                  this.PolicyGroupSection(group)
                })
              }

            }
            .width('100%')
          }
          .constraintSize({ maxHeight: '60%' })
          .scrollBar(BarState.Off)

          // åº•éƒ¨è´­ç‰©æ 
          Row() {
            // ä»·æ ¼ä¿¡æ¯
            Column() {
              Row() {
                Text(this.currencySymbol)
                  .fontSize(14)
                  .fontColor('#C4A000')
                Text(this.calculateTotalPrice())
                  .fontSize(22)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#C4A000')
              }
              .alignItems(VerticalAlign.Bottom)

              Text(this.selectedProduct.local_name)
                .fontSize(12)
                .fontColor('#666666')
                .maxLines(1)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
                .margin({ top: 2 })
            }
            .alignItems(HorizontalAlign.Start)
            .layoutWeight(1)

            // æ•°é‡é€‰æ‹©å™¨
            Row() {
              Text('ï¼')
                .width(32)
                .height(32)
                .fontSize(18)
                .fontColor(this.quantity > 1 ? '#333333' : '#CCCCCC')
                .textAlign(TextAlign.Center)
                .backgroundColor('#F5F5F5')
                .borderRadius(16)
                .onClick(() => {
                  if (this.quantity > 1) {
                    this.quantity--;
                  }
                })

              Text(this.quantity.toString())
                .width(40)
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .fontColor('#333333')
                .textAlign(TextAlign.Center)

              Text('ï¼‹')
                .width(32)
                .height(32)
                .fontSize(18)
                .fontColor('#333333')
                .textAlign(TextAlign.Center)
                .backgroundColor('#F5F5F5')
                .borderRadius(16)
                .onClick(() => {
                  this.quantity++;
                })
            }
            .margin({ right: 12 })

            // åŠ å…¥è´­ç‰©ç¯®æŒ‰é’®
            Button('åŠ å…¥è³¼ç‰©ç±ƒ')
              .height(44)
              .fontSize(15)
              .fontColor('#333333')
              .backgroundColor(this.themeColor)
              .borderRadius(22)
              .padding({ left: 20, right: 20 })
              .onClick(() => {
                this.addToCart();
              })
          }
          .width('100%')
          .height(70)
          .padding({ left: 16, right: 16 })
          .backgroundColor('#FFFFFF')
          .border({ width: { top: 0.5 }, color: '#E5E5E5' })
          .alignItems(VerticalAlign.Center)
        } else {
          // åŠ è½½å¤±è´¥
          Column() {
            Text('è¼‰å…¥å¤±æ•—')
              .fontSize(15)
              .fontColor('#999999')
          }
          .width('100%')
          .height(150)
          .justifyContent(FlexAlign.Center)
        }
      }
      .width('100%')
      .backgroundColor('#FFFFFF')
      .borderRadius({ topLeft: 16, topRight: 16 })

      // é…æ–™é€‰æ‹©å¼¹çª—å±‚ï¼ˆè¦†ç›–åœ¨äº§å“è¯¦æƒ…ä¹‹ä¸Šï¼‰
      if (this.showCondimentSheet) {
        // é®ç½©å±‚
        Column()
          .width('100%')
          .height('100%')
          .backgroundColor('rgba(0, 0, 0, 0.3)')
          .onClick(() => {
            this.closeCondimentSheet();
          })

        // é…æ–™é€‰æ‹©å¼¹çª—å†…å®¹
        this.CondimentSelectionSheet()
      }
    }
    .width('100%')
    .height('100%')
  }

  // è§„æ ¼é€‰æ‹©åŒº
  @Builder
  PriceSpecSection(product: ProductDetail) {
    Column() {
      // æ ‡é¢˜
      Text('è¦æ ¼')
        .fontSize(15)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')
        .width('100%')
        .padding({ left: 16, right: 16, top: 12, bottom: 8 })

      // è§„æ ¼é€‰é¡¹
      Flex({ wrap: FlexWrap.Wrap }) {
        ForEach(product.prices, (price: Object, index: number) => {
          Text(this.getPriceSpecName(price, index))
            .fontSize(14)
            .fontColor(this.selectedPriceIndex === index ? '#333333' : '#666666')
            .backgroundColor(this.selectedPriceIndex === index ? this.themeColor : '#F5F5F5')
            .borderRadius(16)
            .padding({ left: 16, right: 16, top: 8, bottom: 8 })
            .margin({ right: 10, bottom: 10 })
            .onClick(() => {
              this.selectedPriceIndex = index;
            })
        })
      }
      .width('100%')
      .padding({ left: 16, right: 16 })
    }
    .width('100%')
    .backgroundColor('#FFFFFF')
  }

  /**
   * è·å–è§„æ ¼åç§°
   */
  private getPriceSpecName(price: Object, index: number): string {
    const priceObj = price as Record<string, Object>;
    if (priceObj['productStandardItem']) {
      const standardItem = priceObj['productStandardItem'] as Record<string, string>;
      return standardItem['local_name'] || `è¦æ ¼${index + 1}`;
    }
    return (priceObj as Record<string, string>)['local_name'] || `è¦æ ¼${index + 1}`;
  }

  // ä¸»å•†å“é…æ–™é€‰æ‹©ç»„ï¼ˆç”œåº¦ã€å†°é‡ç­‰ï¼‰
  @Builder
  ProductCondimentGroupSection(group: CondimentGroupDetail) {
    Column() {
      // ç»„æ ‡é¢˜
      Row() {
        Text(group.local_name)
          .fontSize(15)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')

        // å¿…é€‰æç¤º
        Text('è«‹é¸æ“‡1é …')
          .fontSize(12)
          .fontColor('#FF6600')
          .margin({ left: 8 })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 16, bottom: 8 })

      // é…æ–™é¡¹åˆ—è¡¨
      ForEach(group.item, (item: CondimentItemDetail) => {
        this.ProductCondimentItemRow(group, item)
      })
    }
    .width('100%')
    .backgroundColor('#FFFFFF')
  }

  // ä¸»å•†å“é…æ–™é¡¹è¡Œ
  @Builder
  ProductCondimentItemRow(group: CondimentGroupDetail, item: CondimentItemDetail) {
    Row() {
      // é…æ–™åç§°
      Text(item.local_name)
        .fontSize(15)
        .fontColor('#333333')
        .layoutWeight(1)

      // åŠ ä»·æ˜¾ç¤º
      if (parseFloat(item.price || '0') > 0) {
        Text(`+${this.currencySymbol}${parseFloat(item.price).toFixed(0)}`)
          .fontSize(13)
          .fontColor('#666666')
          .margin({ right: 12 })
      }

      // é€‰ä¸­çŠ¶æ€åœ†å½¢
      Column() {
        if (this.isProductCondimentSelected(group.condiment_group_id, item.condiment_item_id)) {
          Column()
            .width(12)
            .height(12)
            .borderRadius(6)
            .backgroundColor(this.themeColor)
        }
      }
      .width(22)
      .height(22)
      .borderRadius(11)
      .border({
        width: 2,
        color: this.isProductCondimentSelected(group.condiment_group_id, item.condiment_item_id) ? this.themeColor : '#DDDDDD'
      })
      .justifyContent(FlexAlign.Center)
    }
    .width('100%')
    .height(50)
    .padding({ left: 16, right: 16 })
    .border({ width: { bottom: 0.5 }, color: '#F0F0F0' })
    .onClick(() => {
      this.selectProductCondiment(group.condiment_group_id, item.condiment_item_id);
    })
  }

  // é…æ–™é€‰æ‹©ç»„
  @Builder
  PackageGroupSection(group: PackageGroup) {
    Column() {
      // ç»„æ ‡é¢˜
      Row() {
        Text(group.local_name)
          .fontSize(15)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')

        // å¿…é€‰æç¤º
        if (parseInt(group.select_count) > 0) {
          Text(`è«‹é¸æ“‡${group.select_count}é …`)
            .fontSize(12)
            .fontColor('#FF6600')
            .margin({ left: 8 })
        }
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 16, bottom: 8 })

      // é…æ–™é¡¹åˆ—è¡¨
      ForEach(group.item, (item: PackageItem) => {
        this.PackageItemRow(group, item)
      })
    }
    .width('100%')
    .backgroundColor('#FFFFFF')
  }

  // é…æ–™é¡¹è¡Œ
  @Builder
  PackageItemRow(group: PackageGroup, item: PackageItem) {
    Row() {
      // é…æ–™åç§°
      Column() {
        Text(item.local_name)
          .fontSize(14)
          .fontColor('#333333')

        // æè¿°ï¼ˆå¦‚æœæœ‰ï¼‰
        if (item.description?.local_description) {
          Text(item.description.local_description)
            .fontSize(12)
            .fontColor('#999999')
            .margin({ top: 2 })
        }
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      // åŠ ä»·æ˜¾ç¤º
      if (this.getItemAddPrice(item) > 0) {
        Text(`+${this.currencySymbol}${this.getItemAddPrice(item).toFixed(0)}`)
          .fontSize(13)
          .fontColor('#666666')
          .margin({ right: 12 })
      }

      // é€‰æ‹©æŒ‰é’®
      if (group.select_type === '2') {
        // å•é€‰ - åœ†å½¢
        Radio({ value: item.product_id, group: group.id })
          .checked(this.isPackageItemSelected(group.id, item.product_id))
          .width(22)
          .height(22)
          .onChange((isChecked: boolean) => {
            if (isChecked) {
              this.togglePackageItem(group.id, item.product_id, group.select_type, parseInt(group.max_count) || 0);
            }
          })
      } else {
        // å¤šé€‰ - åŠ å·/å‹¾é€‰æŒ‰é’®
        Column() {
          if (this.isPackageItemSelected(group.id, item.product_id)) {
            Text('âœ“')
              .fontSize(14)
              .fontColor('#FFFFFF')
          } else {
            Text('+')
              .fontSize(18)
              .fontColor('#999999')
          }
        }
        .width(24)
        .height(24)
        .borderRadius(12)
        .backgroundColor(this.isPackageItemSelected(group.id, item.product_id) ? this.themeColor : '#F5F5F5')
        .border({ width: 1, color: this.isPackageItemSelected(group.id, item.product_id) ? this.themeColor : '#E5E5E5' })
        .justifyContent(FlexAlign.Center)
        .onClick(() => {
          this.togglePackageItem(group.id, item.product_id, group.select_type, parseInt(group.max_count) || 0);
        })
      }
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 12, bottom: 12 })
    .border({ width: { bottom: 0.5 }, color: '#F0F0F0' })
  }

  // åŠ é€é€‰æ‹©ç»„ï¼ˆæ¥è‡ª policy APIï¼‰
  @Builder
  PolicyGroupSection(group: PolicyGroup) {
    Column() {
      // ç»„æ ‡é¢˜
      Row() {
        Text(`åŠ é¸Â·${group.local_name}`)
          .fontSize(15)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .layoutWeight(1)

        // å¿…é€‰æç¤º
        if (group.required === '1') {
          Text(`è«‹é¸æ“‡${group.free_count || '1'}é …`)
            .fontSize(12)
            .fontColor('#FF6600')
        }
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 16, bottom: 8 })

      // åŠ é€é¡¹åˆ—è¡¨
      ForEach(group.item, (item: PolicyGroupItem) => {
        this.PolicyItemRow(group, item)
      })
    }
    .width('100%')
    .backgroundColor('#FFFFFF')
    .margin({ top: 8 })
  }

  // åŠ é€é¡¹è¡Œ
  @Builder
  PolicyItemRow(group: PolicyGroup, item: PolicyGroupItem) {
    Row() {
      // é¡¹ç›®åç§°å’Œæè¿°
      Column() {
        Text(item.local_name)
          .fontSize(14)
          .fontColor('#333333')

        // æ˜¾ç¤ºé…æ–™ç»„æç¤ºï¼ˆå¦‚ï¼šå¯é€‰ç”œåº¦ã€å†°é‡ç­‰ï¼‰
        if (item.condiment_group && item.condiment_group.length > 0) {
          Text(`${item.short_name || item.local_name}Â·å¯é¸åŠ æ–™`)
            .fontSize(12)
            .fontColor('#999999')
            .margin({ top: 2 })
        }
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      // åŠ ä»·æ˜¾ç¤º
      if (this.getPolicyItemAddPrice(item) > 0) {
        Text(`+${this.currencySymbol}${this.getPolicyItemAddPrice(item).toFixed(0)}`)
          .fontSize(13)
          .fontColor('#666666')
          .margin({ right: 12 })
      }

      // é€‰æ‹©æŒ‰é’®ï¼ˆå•é€‰åœ†å½¢ï¼‰
      Radio({ value: item.product_id, group: `policy_${group.id}` })
        .checked(this.isPolicyItemSelected(group.id, item.product_id))
        .width(22)
        .height(22)
        .onChange((isChecked: boolean) => {
          if (isChecked) {
            // å¦‚æœå•†å“æœ‰é…æ–™ç»„ï¼ˆç”œåº¦ã€å†°é‡ç­‰ï¼‰ï¼Œæ‰“å¼€é…æ–™é€‰æ‹©å¼¹çª—
            if (item.condiment_group && item.condiment_group.length > 0) {
              this.openCondimentSheet(group.id, item);
            } else {
              // æ²¡æœ‰é…æ–™ç»„ï¼Œç›´æ¥é€‰ä¸­
              this.selectPolicyItem(group.id, item.product_id);
            }
          }
        })
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 12, bottom: 12 })
    .border({ width: { bottom: 0.5 }, color: '#F0F0F0' })
    .onClick(() => {
      // ç‚¹å‡»æ•´è¡Œä¹Ÿå¯ä»¥æ‰“å¼€é…æ–™é€‰æ‹©ï¼ˆå¦‚æœæœ‰é…æ–™ç»„ï¼‰
      if (item.condiment_group && item.condiment_group.length > 0) {
        this.openCondimentSheet(group.id, item);
      } else {
        this.selectPolicyItem(group.id, item.product_id);
      }
    })
  }

  // è·å–åŠ é€é¡¹åŠ ä»·
  private getPolicyItemAddPrice(item: PolicyGroupItem): number {
    if (item.prices && item.prices.length > 0) {
      return parseFloat(item.prices[0].add_price || '0');
    }
    return 0;
  }

  // åŠ é€å•†å“é…æ–™é€‰æ‹©å¼¹çª—
  @Builder
  CondimentSelectionSheet() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      Row() {
        // è¿”å›ç®­å¤´
        Text('â€¹')
          .width(40)
          .height(44)
          .fontSize(28)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
          .textAlign(TextAlign.Center)
          .onClick(() => {
            this.closeCondimentSheet();
          })

        // å•†å“åç§°
        Text(this.selectedPolicyItem?.local_name || '')
          .fontSize(17)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        // ç¡®è®¤æŒ‰é’®
        Text('ç¢ºèª')
          .fontSize(14)
          .fontColor('#FFFFFF')
          .backgroundColor(this.themeColor)
          .borderRadius(4)
          .padding({ left: 12, right: 12, top: 6, bottom: 6 })
          .margin({ right: 12 })
          .onClick(() => {
            this.confirmCondimentSelection();
          })
      }
      .width('100%')
      .height(48)
      .backgroundColor('#FFFFFF')
      .border({ width: { bottom: 0.5 }, color: '#E5E5E5' })

      // è§„æ ¼é€‰æ‹© + é…æ–™ç»„åˆ—è¡¨
      if (this.selectedPolicyItem) {
        Scroll() {
          Column() {
            // è§„æ ¼é€‰æ‹©ï¼ˆå¦‚æœæœ‰å¤šä¸ªpricesï¼Œæ˜¾ç¤ºçƒ­/å†»ç­‰é€‰æ‹©ï¼‰
            if (this.selectedPolicyItem.prices && this.selectedPolicyItem.prices.length > 1) {
              this.PriceSpecSelectionSection()
            }

            // é…æ–™ç»„åˆ—è¡¨
            if (this.selectedPolicyItem.condiment_group) {
              ForEach(this.selectedPolicyItem.condiment_group, (group: CondimentGroupDetail) => {
                this.CondimentGroupSection(group)
              })
            }

            // åº•éƒ¨é—´è·
            Column()
              .width('100%')
              .height(20)
          }
          .width('100%')
        }
        .layoutWeight(1)
        .scrollBar(BarState.Off)
      }
    }
    .width('100%')
    .height('70%')
    .backgroundColor('#F5F5F5')
    .borderRadius({ topLeft: 16, topRight: 16 })
    .position({ x: 0, y: '30%' })
  }

  // è§„æ ¼é€‰æ‹©åŒºåŸŸï¼ˆpricesæ•°ç»„ï¼Œå¦‚ç†±/å‡ï¼‰
  @Builder
  PriceSpecSelectionSection() {
    Column() {
      // ç»„æ ‡é¢˜
      Row() {
        Text('è¦æ ¼')
          .fontSize(14)
          .fontColor('#999999')

        Blank()

        // å¿…é€‰æç¤º
        Text('è«‹é¸æ“‡1é …')
          .fontSize(12)
          .fontColor('#999999')
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 8 })

      // è§„æ ¼é€‰é¡¹åˆ—è¡¨
      Column() {
        if (this.selectedPolicyItem && this.selectedPolicyItem.prices) {
          ForEach(this.selectedPolicyItem.prices, (price: Object, index: number) => {
            this.PriceSpecItemRow(price, index)
          })
        }
      }
      .width('100%')
      .backgroundColor('#FFFFFF')
    }
    .width('100%')
  }

  // è§„æ ¼é€‰é¡¹è¡Œ
  @Builder
  PriceSpecItemRow(price: Object, index: number) {
    Row() {
      // è§„æ ¼åç§°
      Text(this.getPolicyPriceSpecName(price))
        .fontSize(15)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')
        .layoutWeight(1)

      // åŠ ä»·æ˜¾ç¤ºï¼ˆå¦‚æœæœ‰ï¼‰
      if (this.getPolicyPriceAddPrice(price) > 0) {
        Text(`+${this.currencySymbol}${this.getPolicyPriceAddPrice(price).toFixed(0)}`)
          .fontSize(13)
          .fontColor('#666666')
          .margin({ right: 12 })
      }

      // é€‰æ‹©çŠ¶æ€åœ†å½¢ï¼ˆå•é€‰ï¼‰
      Column() {
        if (this.selectedPolicyPriceIndex === index) {
          // é€‰ä¸­çŠ¶æ€ - é»„è‰²å®å¿ƒåœ†
          Column()
            .width(12)
            .height(12)
            .borderRadius(6)
            .backgroundColor(this.themeColor)
        }
      }
      .width(22)
      .height(22)
      .borderRadius(11)
      .border({
        width: 2,
        color: this.selectedPolicyPriceIndex === index ? this.themeColor : '#DDDDDD'
      })
      .justifyContent(FlexAlign.Center)
    }
    .width('100%')
    .height(50)
    .padding({ left: 16, right: 16 })
    .border({ width: { bottom: 0.5 }, color: '#F0F0F0' })
    .onClick(() => {
      this.selectedPolicyPriceIndex = index;
    })
  }

  /**
   * è·å–åŠ é€å•†å“è§„æ ¼åç§°
   */
  private getPolicyPriceSpecName(price: Object): string {
    const priceObj = price as Record<string, string>;
    return priceObj['local_name'] || priceObj['en_name'] || 'è¦æ ¼';
  }

  /**
   * è·å–åŠ é€å•†å“è§„æ ¼åŠ ä»·
   */
  private getPolicyPriceAddPrice(price: Object): number {
    const priceObj = price as Record<string, string>;
    if (this.orderType === OrderType.PICKUP) {
      return parseFloat(priceObj['add_takeout_price'] || priceObj['add_price'] || '0');
    }
    return parseFloat(priceObj['add_price'] || '0');
  }

  // é…æ–™ç»„åŒºåŸŸ
  @Builder
  CondimentGroupSection(group: CondimentGroupDetail) {
    Column() {
      // ç»„æ ‡é¢˜
      Row() {
        Text(group.local_name)
          .fontSize(14)
          .fontColor('#999999')

        Blank()

        // å¿…é€‰æç¤º
        Text('è«‹é¸æ“‡1é …')
          .fontSize(12)
          .fontColor('#999999')
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 8 })

      // é…æ–™é¡¹åˆ—è¡¨
      Column() {
        ForEach(group.item, (item: CondimentItemDetail) => {
          this.CondimentItemRow(group, item)
        })
      }
      .width('100%')
      .backgroundColor('#FFFFFF')
    }
    .width('100%')
  }

  // é…æ–™é¡¹è¡Œ
  @Builder
  CondimentItemRow(group: CondimentGroupDetail, item: CondimentItemDetail) {
    Row() {
      // é…æ–™åç§°
      Text(item.local_name)
        .fontSize(15)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')
        .layoutWeight(1)

      // åŠ ä»·æ˜¾ç¤ºï¼ˆå¦‚æœæœ‰ï¼‰
      if (parseFloat(item.price || '0') > 0) {
        Text(`+${this.currencySymbol}${parseFloat(item.price).toFixed(0)}`)
          .fontSize(13)
          .fontColor('#666666')
          .margin({ right: 12 })
      }

      // é€‰æ‹©çŠ¶æ€åœ†å½¢ï¼ˆå•é€‰ï¼‰
      Column() {
        if (this.isCondimentItemSelected(group.condiment_group_id, item.condiment_item_id)) {
          // é€‰ä¸­çŠ¶æ€ - é»„è‰²å®å¿ƒåœ†
          Column()
            .width(12)
            .height(12)
            .borderRadius(6)
            .backgroundColor(this.themeColor)
        }
      }
      .width(22)
      .height(22)
      .borderRadius(11)
      .border({
        width: 2,
        color: this.isCondimentItemSelected(group.condiment_group_id, item.condiment_item_id) ? this.themeColor : '#DDDDDD'
      })
      .justifyContent(FlexAlign.Center)
    }
    .width('100%')
    .height(50)
    .padding({ left: 16, right: 16 })
    .border({ width: { bottom: 0.5 }, color: '#F0F0F0' })
    .onClick(() => {
      this.selectCondimentItem(group.condiment_group_id, item.condiment_item_id);
    })
  }

  // è´­ç‰©è½¦æ‚¬æµ®å¡ç‰‡
  @Builder
  CartBottomBar() {
    Row() {
      // è´­ç‰©è½¦å›¾æ ‡åŒºåŸŸï¼ˆç‚¹å‡»å±•å¼€å¼¹çª—ï¼‰
      Stack() {
        // è´­ç‰©è½¦å›¾æ ‡èƒŒæ™¯åœ†å½¢
        Column() {
          Text('ğŸ›’')
            .fontSize(22)
        }
        .width(42)
        .height(42)
        .borderRadius(21)
        .backgroundColor('rgba(255, 255, 255, 0.4)')
        .justifyContent(FlexAlign.Center)

        // æ•°é‡å¾½ç« 
        if (this.cartCount > 0) {
          Text(this.cartCount > 99 ? '99+' : this.cartCount.toString())
            .fontSize(11)
            .fontColor('#FFFFFF')
            .fontWeight(FontWeight.Bold)
            .backgroundColor('#FF6B00')
            .borderRadius(9)
            .constraintSize({ minWidth: 18 })
            .height(18)
            .textAlign(TextAlign.Center)
            .padding({ left: 4, right: 4 })
            .position({ x: 26, y: -2 })
        }
      }
      .width(46)
      .height(42)
      .onClick(() => {
        this.showCartPopup = !this.showCartPopup;
      })

      // æ€»æ•°é‡‘é¢
      Row() {
        Text('ç¸½æ•¸')
          .fontSize(14)
          .fontColor('#333333')
        Text(` ${this.currencySymbol}${this.cartTotal.toFixed(0)}`)
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
      }
      .layoutWeight(1)
      .justifyContent(FlexAlign.Start)
      .margin({ left: 8 })

      // ä¸‹ä¸€æ­¥æŒ‰é’®
      Button('ä¸‹ä¸€æ­¥')
        .fontSize(15)
        .fontWeight(FontWeight.Medium)
        .fontColor('#FFFFFF')
        .backgroundColor('#333333')
        .borderRadius(20)
        .height(40)
        .padding({ left: 24, right: 24 })
        .onClick(() => {
          this.goToCheckout();
        })
    }
    .height(50)
    .padding({ left: 10, right: 10 })
    .margin({ left: 10, right: 10, bottom: 0 })
    .backgroundColor(this.themeColor)
    .borderRadius(25)
    .shadow({
      radius: 16,
      color: 'rgba(0, 0, 0, 0.2)',
      offsetX: 0,
      offsetY: 4
    })
    .position({ x: 0, y: '100%' })
    .translate({ y: -66 })
  }

  // è´­ç‰©è½¦å•†å“åˆ—è¡¨å¼¹çª—ï¼ˆä»åº•éƒ¨å¼¹å‡ºï¼Œåœ¨æ‚¬æµ®å¡ç‰‡ä¸‹å±‚ï¼‰
  @Builder
  CartPopup() {
    Stack({ alignContent: Alignment.Bottom }) {
      // åŠé€æ˜é®ç½©ï¼ˆç‚¹å‡»å…³é—­ï¼‰
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.4)')
        .onClick(() => {
          this.showCartPopup = false;
        })

      // è´­ç‰©è½¦å•†å“åˆ—è¡¨åŒºåŸŸï¼ˆä»åº•éƒ¨å¼¹å‡ºï¼Œåœ¨æ‚¬æµ®å¡ç‰‡ä¸‹æ–¹ï¼‰
      Column() {
        // æ ‡é¢˜æ 
        Row() {
          Text('è³¼ç‰©è»Š')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')

          Blank()

          // æ¸…ç©ºè´­ç‰©è½¦æŒ‰é’®
          Row() {
            Text('ğŸ—‘')
              .fontSize(14)
              .margin({ right: 4 })
            Text('æ¸…ç©ºè³¼ç‰©è»Š')
              .fontSize(13)
              .fontColor('#999999')
          }
          .onClick(() => {
            this.clearCart();
          })
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 16, bottom: 12 })

        // è´­ç‰©è½¦å•†å“åˆ—è¡¨
        List() {
          ForEach(appState.cartItems, (item: CartItem) => {
            ListItem() {
              this.CartItemRow(item)
            }
          })
        }
        .width('100%')
        .constraintSize({ maxHeight: 300 })
        .divider({ strokeWidth: 0.5, color: '#F0F0F0', startMargin: 16, endMargin: 16 })
      }
      .width('100%')
      .backgroundColor('#FFFFFF')
      .borderRadius({ topLeft: 16, topRight: 16 })
      .padding({ bottom: 76 })  // ä¸ºæ‚¬æµ®è´­ç‰©è½¦å¡ç‰‡ç•™å‡ºç©ºé—´
    }
    .width('100%')
    .height('100%')
  }

  // è´­ç‰©è½¦å•†å“é¡¹
  @Builder
  CartItemRow(item: CartItem) {
    Row() {
      // å•†å“ä¿¡æ¯
      Column() {
        // å•†å“åç§°
        Text(item.productName)
          .fontSize(15)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        // è§„æ ¼æè¿°
        if (item.specDescription) {
          Text(item.specDescription)
            .fontSize(12)
            .fontColor('#999999')
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .margin({ top: 4 })
        }
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      // ä»·æ ¼
      Text(`${this.currencySymbol}${item.unitPrice.toFixed(0)}`)
        .fontSize(15)
        .fontWeight(FontWeight.Bold)
        .fontColor(this.themeColor)
        .margin({ left: 12, right: 12 })

      // æ•°é‡æ§åˆ¶å™¨
      Row() {
        // å‡å°‘æŒ‰é’®
        Text('âˆ’')
          .width(28)
          .height(28)
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(item.quantity > 1 ? '#333333' : '#CCCCCC')
          .textAlign(TextAlign.Center)
          .borderRadius(14)
          .border({ width: 1, color: item.quantity > 1 ? '#DDDDDD' : '#EEEEEE' })
          .onClick(() => {
            if (item.quantity > 1) {
              this.updateCartItemQuantity(item.cartItemId, item.quantity - 1);
            } else {
              this.removeCartItem(item.cartItemId);
            }
          })

        // æ•°é‡
        Text(item.quantity.toString())
          .fontSize(15)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .width(36)
          .textAlign(TextAlign.Center)

        // å¢åŠ æŒ‰é’®
        Text('+')
          .width(28)
          .height(28)
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
          .textAlign(TextAlign.Center)
          .borderRadius(14)
          .border({ width: 1, color: '#DDDDDD' })
          .onClick(() => {
            this.updateCartItemQuantity(item.cartItemId, item.quantity + 1);
          })
      }
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 12, bottom: 12 })
  }

  /**
   * æ›´æ–°è´­ç‰©è½¦å•†å“æ•°é‡
   */
  private async updateCartItemQuantity(cartItemId: string, quantity: number): Promise<void> {
    await appState.updateCartItemQuantity(cartItemId, quantity);
    this.updateCartState();
  }

  /**
   * åˆ é™¤è´­ç‰©è½¦å•†å“
   */
  private async removeCartItem(cartItemId: string): Promise<void> {
    await appState.removeCartItem(cartItemId);
    this.updateCartState();
    // å¦‚æœè´­ç‰©è½¦ä¸ºç©ºï¼Œå…³é—­å¼¹çª—
    if (this.cartCount === 0) {
      this.showCartPopup = false;
    }
  }

  /**
   * æ¸…ç©ºè´­ç‰©è½¦
   */
  private async clearCart(): Promise<void> {
    await appState.clearCart();
    this.updateCartState();
    this.showCartPopup = false;
  }

  /**
   * å‰å¾€ç»“ç®—é¡µé¢
   */
  private goToCheckout(): void {
    hilog.info(DOMAIN, TAG, 'Go to checkout, total: %{public}d', this.cartTotal);
    // TODO: è·³è½¬åˆ°ç»“ç®—é¡µé¢
  }

  // æ£€æŸ¥åŠ é€é¡¹æ˜¯å¦è¢«é€‰ä¸­
  private isPolicyItemSelected(groupId: string, itemProductId: string): boolean {
    const selectedSet = this.selectedPackageItems.get(`policy_${groupId}`);
    return selectedSet ? selectedSet.has(itemProductId) : false;
  }

  // é€‰æ‹©åŠ é€é¡¹ï¼ˆå•é€‰ï¼‰
  private selectPolicyItem(groupId: string, itemProductId: string): void {
    const key = `policy_${groupId}`;
    const selectedSet = new Set<string>();
    selectedSet.add(itemProductId);
    this.selectedPackageItems.set(key, selectedSet);
    // è§¦å‘ UI æ›´æ–°
    this.selectedPackageItems = new Map(this.selectedPackageItems);
  }

  /**
   * æ‰“å¼€åŠ é€å•†å“é…æ–™é€‰æ‹©å¼¹çª—
   */
  private openCondimentSheet(groupId: string, item: PolicyGroupItem): void {
    hilog.info(DOMAIN, TAG, 'Open condiment sheet for: %{public}s, prices: %{public}d',
      item.local_name, item.prices?.length || 0);
    this.selectedPolicyGroupId = groupId;
    this.selectedPolicyItem = item;
    // åˆå§‹åŒ–è§„æ ¼é€‰æ‹©ï¼ˆé»˜è®¤é€‰ç¬¬ä¸€ä¸ªï¼‰
    this.selectedPolicyPriceIndex = 0;
    // åˆå§‹åŒ–é…æ–™é€‰æ‹©ï¼ˆé€‰ä¸­é»˜è®¤é¡¹ï¼‰
    this.selectedCondimentItems = new Map();
    if (item.condiment_group) {
      for (const condimentGroup of item.condiment_group) {
        // æ‰¾åˆ°é»˜è®¤é€‰ä¸­çš„é¡¹
        const defaultItem = condimentGroup.item.find(i => i.is_default === '1');
        if (defaultItem) {
          this.selectedCondimentItems.set(condimentGroup.condiment_group_id, defaultItem.condiment_item_id);
        } else if (condimentGroup.item.length > 0) {
          // å¦‚æœæ²¡æœ‰é»˜è®¤é¡¹ï¼Œé€‰ä¸­ç¬¬ä¸€ä¸ª
          this.selectedCondimentItems.set(condimentGroup.condiment_group_id, condimentGroup.item[0].condiment_item_id);
        }
      }
    }
    this.showCondimentSheet = true;
  }

  /**
   * å…³é—­é…æ–™é€‰æ‹©å¼¹çª—
   */
  private closeCondimentSheet(): void {
    this.showCondimentSheet = false;
    this.selectedPolicyItem = null;
    this.selectedPolicyGroupId = '';
  }

  /**
   * ç¡®è®¤é…æ–™é€‰æ‹©
   */
  private confirmCondimentSelection(): void {
    if (this.selectedPolicyItem && this.selectedPolicyGroupId) {
      // å…ˆé€‰ä¸­è¯¥åŠ é€å•†å“
      this.selectPolicyItem(this.selectedPolicyGroupId, this.selectedPolicyItem.product_id);

      // è·å–è§„æ ¼åç§°
      let priceName = '';
      if (this.selectedPolicyItem.prices && this.selectedPolicyItem.prices.length > this.selectedPolicyPriceIndex) {
        priceName = this.selectedPolicyItem.prices[this.selectedPolicyPriceIndex].local_name || '';
      }

      // æ„å»ºé…æ–™é€‰æ‹©
      const condiments = new Map<string, CondimentSelection>();
      if (this.selectedPolicyItem.condiment_group) {
        for (const group of this.selectedPolicyItem.condiment_group) {
          const selectedItemId = this.selectedCondimentItems.get(group.condiment_group_id);
          if (selectedItemId) {
            const selectedItem = group.item.find(i => i.condiment_item_id === selectedItemId);
            if (selectedItem) {
              condiments.set(group.condiment_group_id, {
                groupName: group.local_name,
                itemId: selectedItem.condiment_item_id,
                itemName: selectedItem.local_name,
                price: parseFloat(selectedItem.price || '0')
              });
            }
          }
        }
      }

      // ä¿å­˜åˆ°å·²ç¡®è®¤é€‰æ‹©
      const selection: ConfirmedPolicySelection = {
        item: this.selectedPolicyItem,
        priceIndex: this.selectedPolicyPriceIndex,
        priceName: priceName,
        condiments: condiments
      };

      const newMap = new Map(this.confirmedPolicySelections);
      newMap.set(this.selectedPolicyGroupId, selection);
      this.confirmedPolicySelections = newMap;

      hilog.info(DOMAIN, TAG, 'Condiment selection confirmed for: %{public}s, spec: %{public}s',
        this.selectedPolicyItem.local_name, priceName);
    }
    this.closeCondimentSheet();
  }

  /**
   * é€‰æ‹©é…æ–™é¡¹
   */
  private selectCondimentItem(condimentGroupId: string, condimentItemId: string): void {
    this.selectedCondimentItems.set(condimentGroupId, condimentItemId);
    // è§¦å‘UIæ›´æ–°
    this.selectedCondimentItems = new Map(this.selectedCondimentItems);
  }

  /**
   * æ£€æŸ¥é…æ–™é¡¹æ˜¯å¦è¢«é€‰ä¸­
   */
  private isCondimentItemSelected(condimentGroupId: string, condimentItemId: string): boolean {
    return this.selectedCondimentItems.get(condimentGroupId) === condimentItemId;
  }

  aboutToAppear() {
    // åˆå§‹åŒ–è´­ç‰©è½¦çŠ¶æ€
    this.updateCartState();

    // è·å–é¡¶éƒ¨å®‰å…¨åŒºåŸŸé«˜åº¦ï¼ˆé¿å¼€èƒ¶å›Šï¼‰
    this.getTopSafeHeight();

    // è·å–è·¯ç”±å‚æ•°
    const params = router.getParams() as Record<string, Object>;
    if (params) {
      this.orderType = (params['orderType'] as OrderType) || OrderType.PICKUP;
      this.themeColor = (params['themeColor'] as string) || '#FFD700';

      // ä»è·¯ç”±å‚æ•°è·å–åº—é“ºä¿¡æ¯
      if (params['storeName']) {
        this.storeName = params['storeName'] as string;
      }
      if (params['storeImage']) {
        this.storeImage = params['storeImage'] as string;
      }
      if (params['notices']) {
        this.notices = params['notices'] as string[];
      }
      if (params['isOpen'] !== undefined) {
        this.isOpen = params['isOpen'] as boolean;
      }
      if (params['storeStatus']) {
        this.storeStatus = params['storeStatus'] as string;
      }
      if (params['todayStatus']) {
        this.todayStatus = params['todayStatus'] as string;
      }
      // åˆå§‹Tabï¼ˆç”¨äºä»é¦–é¡µ"æˆ‘çš„è®¢å•"è·³è½¬ï¼‰
      if (params['initialTab'] !== undefined) {
        this.currentTab = params['initialTab'] as number;
      }
    }

    // å¦‚æœæ²¡æœ‰ä»è·¯ç”±è·å–åˆ°åº—é“ºä¿¡æ¯ï¼Œåˆ™åŠ è½½
    if (!this.storeName) {
      this.loadStoreData();
    }

    // æ ¹æ®åˆå§‹TabåŠ è½½å¯¹åº”æ•°æ®
    if (this.currentTab === 2) {
      // å†å²è®¢å•Tab
      this.loadOrders();
    } else {
      // ç‚¹é¤Tab
      this.loadMenuData();
    }
  }

  /**
   * åŠ è½½åº—é“ºæ•°æ®
   */
  private async loadStoreData(): Promise<void> {
    try {
      // ç¡®ä¿æœ‰æ¸¸å®¢token
      if (!apiService.hasToken()) {
        hilog.info(DOMAIN, TAG, 'No token for store data, getting guest token first');
        await apiService.getGuestToken();
      }

      const response = await apiService.getHomeData();

      if (response.code === 200 && response.data) {
        this.updateStoreInfo(response.data);
      }
    } catch (error) {
      hilog.error(DOMAIN, TAG, 'Failed to load store data: %{public}s', JSON.stringify(error));
      // ä½¿ç”¨é»˜è®¤æ•°æ®
      this.storeName = 'è€é¦®èŒ¶å±…';
    }
  }

  /**
   * æ›´æ–°åº—é“ºä¿¡æ¯
   */
  private updateStoreInfo(data: HomeData): void {
    const config = data.config;

    this.storeName = config.name || 'åº—é“ºåç§°';
    this.storeImage = config.store_image || '';

    this.isOpen = config.is_close !== 1;
    if (!this.isOpen) {
      this.storeStatus = 'å•†å®¶ä¼‘æ¯ä¸­';
      this.todayStatus = 'ä»Šæ—¥ä¼‘æ¥­';
    }

    if (data.notice && data.notice.length > 0) {
      this.notices = data.notice.map(n => n.local_name);
    }
  }

  /**
   * åŠ è½½èœå•æ•°æ®
   */
  private async loadMenuData(): Promise<void> {
    try {
      // ç¡®ä¿æœ‰æ¸¸å®¢token
      if (!apiService.hasToken()) {
        hilog.info(DOMAIN, TAG, 'No token for menu, getting guest token first');
        const tokenSuccess = await apiService.getGuestToken();
        if (!tokenSuccess) {
          hilog.error(DOMAIN, TAG, 'Failed to get guest token for menu');
        }
      }

      const takeout = this.orderType === OrderType.PICKUP ? 1 : 0;
      const response = await apiService.getProductMenus(takeout);

      if (response.code === 200 && response.data) {
        // ä¿å­˜æ‰€æœ‰åˆ†ç»„
        this.allProductGroups = response.data.group || [];
        // ä¿å­˜é¡¶çº§èœå•åˆ†ç»„
        this.menuGroups = response.data.menu_group || [];
        hilog.info(DOMAIN, TAG, 'Menu loaded: %{public}d groups, %{public}d menu_groups',
          this.allProductGroups.length, this.menuGroups.length);

        // æ ¹æ®å½“å‰é€‰ä¸­çš„é¡¶çº§åˆ†ç»„è¿‡æ»¤æ˜¾ç¤ºçš„äºŒçº§åˆ†ç»„
        this.filterProductGroups();
      }
    } catch (error) {
      hilog.error(DOMAIN, TAG, 'Failed to load menu: %{public}s', JSON.stringify(error));
      // å¦‚æœæ²¡æœ‰ menu_groupï¼Œç›´æ¥æ˜¾ç¤ºæ‰€æœ‰åˆ†ç»„
      this.productGroups = this.allProductGroups;
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * é¡¶çº§èœå•åˆ†ç»„é€‰æ‹©
   */
  private onMenuGroupSelect(index: number): void {
    if (this.selectedMenuGroupIndex === index) {
      return;
    }
    this.selectedMenuGroupIndex = index;
    this.selectedGroupIndex = 0;
    this.filterProductGroups();
    // æ»šåŠ¨åˆ°é¡¶éƒ¨
    this.scroller.scrollToIndex(0);
    this.categoryScroller.scrollToIndex(0);
    hilog.info(DOMAIN, TAG, 'Selected menu group: %{public}s', this.menuGroups[index]?.local_name);
  }

  /**
   * æ ¹æ®é€‰ä¸­çš„é¡¶çº§åˆ†ç»„è¿‡æ»¤äºŒçº§åˆ†ç»„
   */
  private filterProductGroups(): void {
    if (this.menuGroups.length === 0) {
      // æ²¡æœ‰é¡¶çº§åˆ†ç»„ï¼Œæ˜¾ç¤ºæ‰€æœ‰
      this.productGroups = this.allProductGroups;
      this.currentShowType = '2'; // é»˜è®¤å¤§å›¾æ¨¡å¼
      return;
    }

    const selectedMenuGroup = this.menuGroups[this.selectedMenuGroupIndex];
    if (!selectedMenuGroup || !selectedMenuGroup.groups || selectedMenuGroup.groups.length === 0) {
      this.productGroups = this.allProductGroups;
      this.currentShowType = '2';
      return;
    }

    // æ›´æ–°å±•ç¤ºç±»å‹
    this.currentShowType = selectedMenuGroup.show_type || '2';

    // æ ¹æ® groups æ•°ç»„è¿‡æ»¤
    const groupIds = new Set(selectedMenuGroup.groups);
    this.productGroups = this.allProductGroups.filter(g => groupIds.has(g.group_id));
    hilog.info(DOMAIN, TAG, 'Filtered groups: %{public}d, show_type: %{public}s',
      this.productGroups.length, this.currentShowType);
  }

  /**
   * è·å–äº§å“ä»·æ ¼
   */
  private getPrice(product: Product): string {
    if (this.orderType === OrderType.PICKUP) {
      return product.takeout_price || product.price;
    }
    return product.price;
  }

  /**
   * è®¡ç®—åˆ†ç»„åœ¨äº§å“åˆ—è¡¨ä¸­çš„èµ·å§‹ç´¢å¼•
   */
  private getProductListIndexForGroup(groupIndex: number): number {
    let index = 0;
    for (let i = 0; i < groupIndex; i++) {
      index += this.productGroups[i].products.length + 1; // +1 for group header
    }
    return index;
  }

  /**
   * æ£€æŸ¥äº§å“æ˜¯å¦æœ‰å¤šè§„æ ¼
   */
  private hasMultipleSpecs(product: Product): boolean {
    return (product.prices && product.prices.length > 1) || (product.condiment_group && product.condiment_group.length > 0);
  }

  /**
   * æ˜¾ç¤ºäº§å“è¯¦æƒ…ï¼ˆç‚¹å‡»äº§å“å¡ç‰‡ï¼‰
   * è°ƒç”¨äº§å“è¯¦æƒ…APIè·å–å®Œæ•´æ•°æ®ï¼ˆåŒ…å«é…æ–™é€‰æ‹©ï¼‰
   */
  private openProductDetail(product: Product): void {
    hilog.info(DOMAIN, TAG, 'Open product detail: %{public}s (id=%{public}s)', product.local_name, product.product_id);

    // é‡ç½®é€‰æ‹©çŠ¶æ€
    this.selectedPriceIndex = 0;
    this.selectedPackageItems = new Map();
    this.selectedProductCondiments = new Map();
    this.quantity = 1;

    // å…ˆæ˜¾ç¤ºåŠ è½½çŠ¶æ€
    this.isDetailLoading = true;
    this.showProductDetail = true;
    this.selectedProduct = this.convertToProductDetail(product);

    // è°ƒç”¨APIè·å–å®Œæ•´è¯¦æƒ…ï¼ˆåŒ…å«packageGroupsé…æ–™æ•°æ®ï¼‰
    const orderType = this.orderType === OrderType.PICKUP ? 1 : 2;
    this.fetchProductDetail(product.product_id, orderType);
  }

  /**
   * è·å–äº§å“è¯¦æƒ…ï¼ˆå¸¦tokenæ£€æŸ¥ï¼‰
   */
  private async fetchProductDetail(productId: string, orderType: number): Promise<void> {
    try {
      // ç¡®ä¿æœ‰æ¸¸å®¢token
      if (!apiService.hasToken()) {
        hilog.info(DOMAIN, TAG, 'No token for product detail, getting guest token first');
        const tokenSuccess = await apiService.getGuestToken();
        if (!tokenSuccess) {
          hilog.error(DOMAIN, TAG, 'Failed to get guest token for product detail');
          this.isDetailLoading = false;
          return;
        }
      }

      // é‡ç½®æ”¿ç­–ç»„æ•°æ®
      this.policyGroups = [];

      const response = await apiService.getProductDetail(productId, orderType);
      if (response.code === 200 && response.data) {
        this.selectedProduct = response.data;
        hilog.info(DOMAIN, TAG, 'Product detail from API: %{public}s, prices: %{public}d, packageGroups: %{public}d, policies: %{public}d, condiment_groups: %{public}d',
          response.data.local_name,
          response.data.prices?.length || 0,
          response.data.packageGroups?.length || 0,
          response.data.policy?.length || 0,
          response.data.condiment_group?.length || 0);

        // åˆå§‹åŒ–ä¸»å•†å“é…æ–™çš„é»˜è®¤é€‰æ‹©
        this.initProductCondimentDefaults(response.data);

        // å¦‚æœæœ‰æ”¿ç­–ï¼Œè·å–æ”¿ç­–è¯¦æƒ…ï¼ˆåŠ é€é€‰æ‹©æ•°æ®ï¼‰
        if (response.data.policy && response.data.policy.length > 0) {
          const policyIds = response.data.policy.map(p => p.policy_id);
          this.fetchPolicyData(policyIds);
        }
      } else {
        hilog.warn(DOMAIN, TAG, 'API returned no data, using menu data. Code: %{public}d, msg: %{public}s',
          response.code, response.msg);
      }
      this.isDetailLoading = false;
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : JSON.stringify(error);
      hilog.error(DOMAIN, TAG, 'Failed to get product detail: %{public}s', errorMsg);
      this.isDetailLoading = false;
    }
  }

  /**
   * è·å–äº§å“æ”¿ç­–æ•°æ®ï¼ˆåŠ é€é€‰æ‹©ï¼‰
   */
  private async fetchPolicyData(policyIds: string[]): Promise<void> {
    try {
      const response = await apiService.getProductPolicy(policyIds);
      if (response.code === 200 && response.data) {
        // æå–æ‰€æœ‰ groupData
        const allGroups: PolicyGroup[] = [];
        for (const policyData of response.data) {
          if (policyData.groupData && policyData.groupData.length > 0) {
            allGroups.push(...policyData.groupData);
          }
        }
        this.policyGroups = allGroups;
        hilog.info(DOMAIN, TAG, 'Policy groups loaded: %{public}d groups', allGroups.length);
      }
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : JSON.stringify(error);
      hilog.error(DOMAIN, TAG, 'Failed to get policy data: %{public}s', errorMsg);
    }
  }

  /**
   * å°†èœå•äº§å“è½¬æ¢ä¸ºè¯¦æƒ…æ ¼å¼
   */
  private convertToProductDetail(product: Product): ProductDetail {
    return {
      product_id: product.product_id,
      store_id: product.store_id,
      local_name: product.local_name,
      cn_name: product.cn_name,
      en_name: product.en_name,
      cover_image: product.cover_image,
      price: product.price,
      takeout_price: product.takeout_price,
      delivery_price: product.delivery_price,
      sale_num: product.sale_num,
      has_stock: product.has_stock,
      takeout: product.takeout,
      dinner_in: product.dinner_in,
      delivery: product.delivery,
      status: product.status,
      description: product.description,
      prices: product.prices || [],
      packageGroups: [],  // èœå•æ•°æ®æ²¡æœ‰packageGroupsï¼Œä½¿ç”¨ç©ºæ•°ç»„
      policy: [],
      condiment_group: product.condiment_group
    };
  }

  /**
   * åˆå§‹åŒ–ä¸»å•†å“é…æ–™çš„é»˜è®¤é€‰æ‹©
   */
  private initProductCondimentDefaults(product: ProductDetail): void {
    this.selectedProductCondiments = new Map();
    if (product.condiment_group) {
      for (const group of product.condiment_group as CondimentGroupDetail[]) {
        // æŸ¥æ‰¾é»˜è®¤é€‰ä¸­é¡¹
        const defaultItem = group.item?.find(item => item.is_default === '1');
        if (defaultItem) {
          this.selectedProductCondiments.set(group.condiment_group_id, defaultItem.condiment_item_id);
        } else if (group.item && group.item.length > 0) {
          // æ²¡æœ‰é»˜è®¤é¡¹åˆ™é€‰ç¬¬ä¸€ä¸ª
          this.selectedProductCondiments.set(group.condiment_group_id, group.item[0].condiment_item_id);
        }
      }
    }
    hilog.info(DOMAIN, TAG, 'Initialized product condiment defaults: %{public}d groups',
      this.selectedProductCondiments.size);
  }

  /**
   * é€‰æ‹©ä¸»å•†å“é…æ–™é¡¹
   */
  private selectProductCondiment(groupId: string, itemId: string): void {
    this.selectedProductCondiments.set(groupId, itemId);
    // è§¦å‘UIæ›´æ–°
    this.selectedProductCondiments = new Map(this.selectedProductCondiments);
  }

  /**
   * æ£€æŸ¥ä¸»å•†å“é…æ–™é¡¹æ˜¯å¦é€‰ä¸­
   */
  private isProductCondimentSelected(groupId: string, itemId: string): boolean {
    return this.selectedProductCondiments.get(groupId) === itemId;
  }

  /**
   * å…³é—­äº§å“è¯¦æƒ…å¼¹çª—
   */
  private closeProductDetail(): void {
    this.showProductDetail = false;
    this.selectedProduct = null;
  }

  /**
   * åˆ‡æ¢é…æ–™é€‰æ‹©
   */
  private togglePackageItem(groupId: string, itemProductId: string, selectType: string, maxCount: number): void {
    let selectedSet = this.selectedPackageItems.get(groupId);
    if (!selectedSet) {
      selectedSet = new Set<string>();
    }

    if (selectType === '2') {
      // å•é€‰æ¨¡å¼
      selectedSet.clear();
      selectedSet.add(itemProductId);
    } else {
      // å¤šé€‰æ¨¡å¼
      if (selectedSet.has(itemProductId)) {
        selectedSet.delete(itemProductId);
      } else {
        // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æœ€å¤§æ•°é‡
        if (maxCount === 0 || selectedSet.size < maxCount) {
          selectedSet.add(itemProductId);
        }
      }
    }

    // åˆ›å»ºæ–°Mapè§¦å‘çŠ¶æ€æ›´æ–°
    const newMap = new Map(this.selectedPackageItems);
    newMap.set(groupId, selectedSet);
    this.selectedPackageItems = newMap;
  }

  /**
   * æ£€æŸ¥é…æ–™é¡¹æ˜¯å¦è¢«é€‰ä¸­
   */
  private isPackageItemSelected(groupId: string, itemProductId: string): boolean {
    const selectedSet = this.selectedPackageItems.get(groupId);
    return selectedSet ? selectedSet.has(itemProductId) : false;
  }

  /**
   * è·å–é…æ–™é¡¹åŠ ä»·
   */
  private getItemAddPrice(item: PackageItem): number {
    if (!item.prices || item.prices.length === 0) {
      return 0;
    }
    if (this.orderType === OrderType.PICKUP) {
      return parseFloat(item.prices[0].add_takeout_price || item.prices[0].add_price || '0');
    }
    return parseFloat(item.prices[0].add_price || '0');
  }

  /**
   * è®¡ç®—æ€»ä»·
   */
  private calculateTotalPrice(): string {
    if (!this.selectedProduct) {
      return '0';
    }

    // åŸºç¡€ä»·æ ¼
    let basePrice = 0;
    if (this.selectedProduct.prices && this.selectedProduct.prices.length > 0) {
      const selectedPrice = this.selectedProduct.prices[this.selectedPriceIndex];
      if (this.orderType === OrderType.PICKUP) {
        basePrice = parseFloat(selectedPrice.takeout_price || selectedPrice.price);
      } else {
        basePrice = parseFloat(selectedPrice.price);
      }
    } else {
      basePrice = parseFloat(this.selectedProduct.price);
    }

    // é…æ–™åŠ ä»·ï¼ˆpackageGroupsï¼‰
    let addPrice = 0;
    if (this.selectedProduct.packageGroups) {
      for (const group of this.selectedProduct.packageGroups) {
        const selectedSet = this.selectedPackageItems.get(group.id);
        if (selectedSet) {
          for (const item of group.item) {
            if (selectedSet.has(item.product_id) && item.prices && item.prices.length > 0) {
              const itemPrice = item.prices[0];
              if (this.orderType === OrderType.PICKUP) {
                addPrice += parseFloat(itemPrice.add_takeout_price || itemPrice.add_price || '0');
              } else {
                addPrice += parseFloat(itemPrice.add_price || '0');
              }
            }
          }
        }
      }
    }

    // ä¸»å•†å“é…æ–™åŠ ä»·ï¼ˆcondiment_groupï¼šç”œåº¦ã€å†°é‡ç­‰ï¼‰
    if (this.selectedProduct.condiment_group) {
      for (const group of this.selectedProduct.condiment_group as CondimentGroupDetail[]) {
        const selectedItemId = this.selectedProductCondiments.get(group.condiment_group_id);
        if (selectedItemId && group.item) {
          const selectedItem = group.item.find(item => item.condiment_item_id === selectedItemId);
          if (selectedItem) {
            if (this.orderType === OrderType.PICKUP) {
              addPrice += parseFloat(selectedItem.takeout_price || selectedItem.price || '0');
            } else {
              addPrice += parseFloat(selectedItem.price || '0');
            }
          }
        }
      }
    }

    const total = (basePrice + addPrice) * this.quantity;
    return total.toFixed(0);
  }

  /**
   * æ£€æŸ¥æ˜¯å¦æ»¡è¶³å¿…é€‰æ¡ä»¶
   */
  private checkRequiredSelections(): boolean {
    if (!this.selectedProduct || !this.selectedProduct.packageGroups) {
      return true;
    }

    for (const group of this.selectedProduct.packageGroups) {
      const minCount = parseInt(group.select_count) || 0;
      if (minCount > 0) {
        const selectedSet = this.selectedPackageItems.get(group.id);
        const selectedCount = selectedSet ? selectedSet.size : 0;
        if (selectedCount < minCount) {
          return false;
        }
      }
    }
    return true;
  }

  /**
   * æ·»åŠ åˆ°è´­ç‰©è½¦
   */
  private async addToCart(): Promise<void> {
    if (!this.selectedProduct) {
      return;
    }

    // æ£€æŸ¥å¿…é€‰é¡¹
    if (!this.checkRequiredSelections()) {
      hilog.warn(DOMAIN, TAG, 'Required selections not met');
      // TODO: æ˜¾ç¤ºæç¤º
      return;
    }

    // æ„å»ºè´­ç‰©è½¦é¡¹
    const cartItem = this.buildCartItem();
    if (!cartItem) {
      hilog.error(DOMAIN, TAG, 'Failed to build cart item');
      return;
    }

    // æ·»åŠ åˆ°è´­ç‰©è½¦
    await appState.addToCart(cartItem);

    // æ›´æ–°è´­ç‰©è½¦çŠ¶æ€
    this.updateCartState();

    hilog.info(DOMAIN, TAG, 'Add to cart: %{public}s x%{public}d, total: %{public}s',
      this.selectedProduct.local_name, this.quantity, this.calculateTotalPrice());

    this.closeProductDetail();
  }

  /**
   * æ„å»ºè´­ç‰©è½¦é¡¹
   */
  private buildCartItem(): CartItemInput | null {
    if (!this.selectedProduct) {
      return null;
    }

    // åŸºç¡€ä¿¡æ¯
    const productId = this.selectedProduct.product_id;
    const productName = this.selectedProduct.local_name;
    const coverImage = this.selectedProduct.cover_image;

    // è§„æ ¼é€‰æ‹©
    let priceName = '';
    let basePrice = 0;
    if (this.selectedProduct.prices && this.selectedProduct.prices.length > 0) {
      const selectedPrice = this.selectedProduct.prices[this.selectedPriceIndex];
      if (selectedPrice.productStandardItem) {
        priceName = selectedPrice.productStandardItem.local_name;
      }
      if (this.orderType === OrderType.PICKUP) {
        basePrice = parseFloat(selectedPrice.takeout_price || selectedPrice.price);
      } else {
        basePrice = parseFloat(selectedPrice.price);
      }
    } else {
      basePrice = parseFloat(this.selectedProduct.price);
    }

    // é…æ–™é€‰æ‹©ï¼ˆpackageGroupsï¼‰
    const packageSelections: CartPackageSelection[] = [];
    if (this.selectedProduct.packageGroups) {
      for (const group of this.selectedProduct.packageGroups) {
        const selectedSet = this.selectedPackageItems.get(group.id);
        if (selectedSet && selectedSet.size > 0) {
          const items: CartPackageItem[] = [];
          for (const item of group.item) {
            if (selectedSet.has(item.product_id)) {
              let addPrice = 0;
              if (item.prices && item.prices.length > 0) {
                if (this.orderType === OrderType.PICKUP) {
                  addPrice = parseFloat(item.prices[0].add_takeout_price || item.prices[0].add_price || '0');
                } else {
                  addPrice = parseFloat(item.prices[0].add_price || '0');
                }
              }
              const pkgItem: CartPackageItem = {
                productId: item.product_id,
                name: item.local_name,
                addPrice: addPrice
              };
              items.push(pkgItem);
            }
          }
          if (items.length > 0) {
            const pkgSelection: CartPackageSelection = {
              groupId: group.id,
              groupName: group.local_name,
              items: items
            };
            packageSelections.push(pkgSelection);
          }
        }
      }
    }

    // ä¸»å•†å“é…æ–™é€‰æ‹©ï¼ˆcondiment_groupï¼šç”œåº¦ã€å†°é‡ç­‰ï¼‰
    if (this.selectedProduct.condiment_group) {
      for (const group of this.selectedProduct.condiment_group as CondimentGroupDetail[]) {
        const selectedItemId = this.selectedProductCondiments.get(group.condiment_group_id);
        if (selectedItemId && group.item) {
          const selectedItem = group.item.find(item => item.condiment_item_id === selectedItemId);
          if (selectedItem) {
            let addPrice = 0;
            if (this.orderType === OrderType.PICKUP) {
              addPrice = parseFloat(selectedItem.takeout_price || selectedItem.price || '0');
            } else {
              addPrice = parseFloat(selectedItem.price || '0');
            }
            const pkgItem: CartPackageItem = {
              productId: selectedItem.condiment_item_id,
              name: selectedItem.local_name,
              addPrice: addPrice
            };
            const pkgSelection: CartPackageSelection = {
              groupId: group.condiment_group_id,
              groupName: group.local_name,
              items: [pkgItem]
            };
            packageSelections.push(pkgSelection);
          }
        }
      }
    }

    // åŠ é€å•†å“é€‰æ‹©
    const policySelections: CartPolicySelection[] = [];
    for (const group of this.policyGroups) {
      const confirmed = this.confirmedPolicySelections.get(group.id);
      if (confirmed) {
        // è®¡ç®—åŠ é€å•†å“åŠ ä»·
        let addPrice = 0;
        if (confirmed.item.prices && confirmed.item.prices.length > confirmed.priceIndex) {
          const price = confirmed.item.prices[confirmed.priceIndex];
          if (this.orderType === OrderType.PICKUP) {
            addPrice = parseFloat(price.add_takeout_price || price.add_price || '0');
          } else {
            addPrice = parseFloat(price.add_price || '0');
          }
        }

        // é…æ–™é€‰æ‹©
        const condiments: CartCondiment[] = [];
        confirmed.condiments.forEach((value, key) => {
          const condiment: CartCondiment = {
            groupId: key,
            groupName: value.groupName,
            itemId: value.itemId,
            itemName: value.itemName,
            price: value.price
          };
          condiments.push(condiment);
        });

        const policyItem: CartPolicyItem = {
          productId: confirmed.item.product_id,
          name: confirmed.item.local_name,
          priceIndex: confirmed.priceIndex,
          priceName: confirmed.priceName,
          addPrice: addPrice,
          condiments: condiments
        };
        const policySelection: CartPolicySelection = {
          groupId: group.id,
          groupName: group.local_name,
          item: policyItem
        };
        policySelections.push(policySelection);
      } else {
        // æ£€æŸ¥æ˜¯å¦æœ‰é€šè¿‡ selectPolicyItem é€‰ä¸­ä½†æ²¡æœ‰é…æ–™çš„é¡¹
        const key = `policy_${group.id}`;
        const selectedSet = this.selectedPackageItems.get(key);
        if (selectedSet && selectedSet.size > 0) {
          const selectedProductId = Array.from(selectedSet)[0];
          const selectedItem = group.item.find(i => i.product_id === selectedProductId);
          if (selectedItem) {
            let addPrice = 0;
            let policyPriceName = '';
            if (selectedItem.prices && selectedItem.prices.length > 0) {
              policyPriceName = selectedItem.prices[0].local_name || '';
              if (this.orderType === OrderType.PICKUP) {
                addPrice = parseFloat(selectedItem.prices[0].add_takeout_price || selectedItem.prices[0].add_price || '0');
              } else {
                addPrice = parseFloat(selectedItem.prices[0].add_price || '0');
              }
            }
            const policyItem: CartPolicyItem = {
              productId: selectedItem.product_id,
              name: selectedItem.local_name,
              priceIndex: 0,
              priceName: policyPriceName,
              addPrice: addPrice,
              condiments: []
            };
            const policySelection: CartPolicySelection = {
              groupId: group.id,
              groupName: group.local_name,
              item: policyItem
            };
            policySelections.push(policySelection);
          }
        }
      }
    }

    // è®¡ç®—å•ä»·
    const unitPrice = parseFloat(this.calculateTotalPrice()) / this.quantity;

    // ç”Ÿæˆè§„æ ¼æè¿°
    const specDescription = this.buildSpecDescription(packageSelections, policySelections);

    const cartItem: CartItemInput = {
      productId: productId,
      productName: productName,
      coverImage: coverImage,
      priceIndex: this.selectedPriceIndex,
      priceName: priceName,
      basePrice: basePrice,
      packageSelections: packageSelections,
      policySelections: policySelections,
      quantity: this.quantity,
      unitPrice: unitPrice,
      specDescription: specDescription
    };
    return cartItem;
  }

  /**
   * æ„å»ºè§„æ ¼æè¿°å­—ç¬¦ä¸²
   */
  private buildSpecDescription(
    packageSelections: CartPackageSelection[],
    policySelections: CartPolicySelection[]
  ): string {
    const parts: string[] = [];

    // é…æ–™é€‰æ‹©
    for (const pkg of packageSelections) {
      for (const item of pkg.items) {
        parts.push(item.name);
      }
    }

    // åŠ é€å•†å“é€‰æ‹©
    for (const policy of policySelections) {
      const policyParts = [policy.item.name];
      if (policy.item.priceName) {
        policyParts.push(policy.item.priceName);
      }
      for (const condiment of policy.item.condiments) {
        policyParts.push(condiment.itemName);
      }
      parts.push(policyParts.join('Â·'));
    }

    return parts.join(' | ');
  }

  /**
   * æ›´æ–°è´­ç‰©è½¦çŠ¶æ€
   */
  private updateCartState(): void {
    this.cartCount = appState.cartCount;
    this.cartTotal = appState.cartTotal;
  }

  /**
   * æ˜¾ç¤ºåº—é“ºè¯¦æƒ…
   */
  private showStoreInfo(): void {
    hilog.info(DOMAIN, TAG, 'Show store info');
    // TODO: è·³è½¬åˆ°åº—é“ºè¯¦æƒ…é¡µ
  }

  /**
   * è·å–é¡¶éƒ¨å®‰å…¨åŒºåŸŸé«˜åº¦ï¼ˆé¿å¼€èƒ¶å›Šï¼‰
   */
  private getTopSafeHeight(): void {
    try {
      const windowInstance = window.getLastWindow(getContext(this));
      windowInstance.then((win: window.Window) => {
        const avoidArea = win.getWindowAvoidArea(window.AvoidAreaType.TYPE_SYSTEM);
        this.topSafeHeight = px2vp(avoidArea.topRect.height);
        hilog.info(DOMAIN, TAG, 'Top safe height: %{public}d', this.topSafeHeight);
      }).catch((err: Error) => {
        hilog.error(DOMAIN, TAG, 'Failed to get window: %{public}s', err.message);
      });
    } catch (error) {
      hilog.error(DOMAIN, TAG, 'Failed to get top safe height: %{public}s', JSON.stringify(error));
    }
  }

  // ==================== è®¢å•ç›¸å…³æ–¹æ³• ====================

  /**
   * åŠ è½½è®¢å•åˆ—è¡¨
   */
  private async loadOrders(): Promise<void> {
    this.isOrderLoading = true;
    this.orderPageNumber = 1;
    this.orders = [];
    this.hasMoreOrders = true;

    try {
      // ç¡®ä¿æœ‰æ¸¸å®¢token
      if (!apiService.hasToken()) {
        hilog.info(DOMAIN, TAG, 'No token for orders, getting guest token first');
        await apiService.getGuestToken();
      }

      const response = await apiService.getOrders(this.orderFilterType, this.orderPageNumber, 10);

      if (response.code === 200 && response.data) {
        this.orders = response.data.order_list || [];
        this.orderTotal = parseInt(response.data.total) || 0;
        this.hasMoreOrders = this.orders.length < this.orderTotal;
        hilog.info(DOMAIN, TAG, 'Orders loaded: %{public}d / %{public}d', this.orders.length, this.orderTotal);
      } else {
        hilog.warn(DOMAIN, TAG, 'Failed to load orders: %{public}s', response.msg);
      }
    } catch (error) {
      hilog.error(DOMAIN, TAG, 'Failed to load orders: %{public}s', JSON.stringify(error));
    } finally {
      this.isOrderLoading = false;
    }
  }

  /**
   * åŠ è½½æ›´å¤šè®¢å•ï¼ˆåˆ†é¡µï¼‰
   */
  private async loadMoreOrders(): Promise<void> {
    if (this.isOrderLoading || !this.hasMoreOrders) {
      return;
    }

    this.isOrderLoading = true;
    this.orderPageNumber++;

    try {
      const response = await apiService.getOrders(this.orderFilterType, this.orderPageNumber, 10);

      if (response.code === 200 && response.data) {
        const newOrders = response.data.order_list || [];
        this.orders = this.orders.concat(newOrders);
        this.hasMoreOrders = this.orders.length < this.orderTotal;
        hilog.info(DOMAIN, TAG, 'More orders loaded: %{public}d / %{public}d', this.orders.length, this.orderTotal);
      }
    } catch (error) {
      hilog.error(DOMAIN, TAG, 'Failed to load more orders: %{public}s', JSON.stringify(error));
      this.orderPageNumber--; // å›é€€é¡µç 
    } finally {
      this.isOrderLoading = false;
    }
  }

  /**
   * ç­›é€‰å™¨åˆ‡æ¢
   */
  private onFilterChange(filterType: OrderFilterType): void {
    this.showFilterDropdown = false;
    if (this.orderFilterType !== filterType) {
      this.orderFilterType = filterType;
      this.loadOrders();
    }
  }

  /**
   * è·å–ç­›é€‰å™¨æ ‡ç­¾
   */
  private getFilterLabel(): string {
    switch (this.orderFilterType) {
      case OrderFilterType.IN_PROGRESS:
        return 'é€²è¡Œä¸­';
      case OrderFilterType.COMPLETED:
        return 'å·²å®Œæˆ';
      case OrderFilterType.REFUND:
        return 'é€€æ¬¾/å–æ¶ˆ';
      default:
        return 'å…¨éƒ¨è¨‚å–®';
    }
  }

  /**
   * è·å–çŠ¶æ€æ˜¾ç¤ºæ–‡æœ¬
   */
  private getStatusText(status: string): string {
    switch (status) {
      case 'pending':
        return 'å¾…è™•ç†';
      case 'confirmed':
        return 'å·²ç¢ºèª';
      case 'preparing':
        return 'æº–å‚™ä¸­';
      case 'ready':
        return 'å¾…å–é¤';
      case 'completed':
        return 'å·²å®Œæˆ';
      case 'cancelled':
        return 'å·²å–æ¶ˆ';
      case 'refunded':
        return 'å·²é€€æ¬¾';
      default:
        return status;
    }
  }

  /**
   * è·å–çŠ¶æ€æ–‡å­—é¢œè‰²
   */
  private getStatusColor(status: string): string {
    switch (status) {
      case 'pending':
      case 'confirmed':
      case 'preparing':
      case 'ready':
        return '#FF8C00'; // è¿›è¡Œä¸­ - æ©™è‰²
      case 'completed':
        return '#4CAF50'; // å·²å®Œæˆ - ç»¿è‰²
      case 'cancelled':
      case 'refunded':
        return '#999999'; // å–æ¶ˆ/é€€æ¬¾ - ç°è‰²
      default:
        return '#666666';
    }
  }

  /**
   * è·å–çŠ¶æ€èƒŒæ™¯é¢œè‰²
   */
  private getStatusBgColor(status: string): string {
    switch (status) {
      case 'pending':
      case 'confirmed':
      case 'preparing':
      case 'ready':
        return '#FFF3E0'; // è¿›è¡Œä¸­ - æµ…æ©™è‰²
      case 'completed':
        return '#E8F5E9'; // å·²å®Œæˆ - æµ…ç»¿è‰²
      case 'cancelled':
      case 'refunded':
        return '#F5F5F5'; // å–æ¶ˆ/é€€æ¬¾ - æµ…ç°è‰²
      default:
        return '#F5F5F5';
    }
  }

  /**
   * å†æ¥ä¸€å•
   */
  private reorder(order: Order): void {
    hilog.info(DOMAIN, TAG, 'Reorder: %{public}s', order.order_no);
    // TODO: å®ç°å†æ¥ä¸€å•é€»è¾‘ï¼Œå°†è®¢å•å•†å“æ·»åŠ åˆ°è´­ç‰©è½¦
  }
}
