import { hilog } from '@kit.PerformanceAnalysisKit';
import { router } from '@kit.ArkUI';
import { apiService } from '../services/ApiService';
import { ProductGroup, Product, OrderType, HomeData } from '../models/StoreModels';

const DOMAIN = 0x0000;
const TAG = 'MenuPage';

@Entry
@Component
struct MenuPage {
  @State isLoading: boolean = true;
  @State productGroups: ProductGroup[] = [];
  @State selectedGroupIndex: number = 0;
  @State orderType: OrderType = OrderType.PICKUP;
  @State themeColor: string = '#FFD700';
  @State currencySymbol: string = '$';

  // åº—é“ºä¿¡æ¯çŠ¶æ€
  @State storeName: string = '';
  @State storeImage: string = '';
  @State storeStatus: string = '';
  @State todayStatus: string = '';
  @State isOpen: boolean = true;
  @State notices: string[] = [];
  @State currentTab: number = 1; // 0=ä¸»é , 1=é»é¤, 2=æ­·å²è¨‚å–®
  @State currentLang: string = 'ç¹';
  @State showNoticeExpand: boolean = false;

  private scroller: Scroller = new Scroller();
  private categoryScroller: Scroller = new Scroller();

  build() {
    Column() {
      // é¡¶éƒ¨åº—é“ºä¿¡æ¯åŒºåŸŸ
      this.StoreHeader()

      // å…¬å‘Šæ 
      if (this.notices.length > 0) {
        this.NoticeBar()
      }

      // Tab å¯¼èˆª
      this.TabBar()

      // æœåŠ¡ç±»å‹å¤´éƒ¨ + è¯­è¨€åˆ‡æ¢
      this.ServiceHeader()

      if (this.isLoading) {
        this.LoadingView()
      } else {
        Row() {
          // å·¦ä¾§åˆ†ç±»åˆ—è¡¨
          this.CategoryList()

          // å³ä¾§äº§å“åˆ—è¡¨
          this.ProductList()
        }
        .layoutWeight(1)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.page_background'))
  }

  // åº—é“ºå¤´éƒ¨ä¿¡æ¯
  @Builder
  StoreHeader() {
    Stack() {
      // èƒŒæ™¯å±‚
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('#E0E0E0')

      // å†…å®¹å±‚
      Row() {
        // è¿”å›æŒ‰é’®
        Text('â€¹')
          .width(32)
          .height(32)
          .fontSize(28)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.text_primary'))
          .textAlign(TextAlign.Center)
          .margin({ left: 8, top: 20 })
          .onClick(() => {
            router.back();
          })

        // åº—é“ºå›¾ç‰‡
        Column() {
          if (this.storeImage) {
            Image(this.storeImage)
              .width(80)
              .height(80)
              .borderRadius(10)
              .objectFit(ImageFit.Cover)
              .shadow({
                radius: 6,
                color: 'rgba(0, 0, 0, 0.15)',
                offsetX: 0,
                offsetY: 3
              })
          } else {
            Image($r('app.media.startIcon'))
              .width(80)
              .height(80)
              .borderRadius(10)
              .objectFit(ImageFit.Cover)
              .shadow({
                radius: 6,
                color: 'rgba(0, 0, 0, 0.15)',
                offsetX: 0,
                offsetY: 3
              })
          }
        }
        .margin({ left: 8, top: 20 })

        // åº—é“ºä¿¡æ¯
        Column() {
          // åº—é“ºåç§°
          Text(this.storeName)
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor($r('app.color.text_primary'))
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })

          // çŠ¶æ€æ ‡ç­¾è¡Œ
          Flex({ wrap: FlexWrap.Wrap }) {
            // å•†å®¶çŠ¶æ€æ ‡ç­¾
            if (this.storeStatus) {
              Text(this.storeStatus)
                .fontSize(11)
                .fontColor($r('app.color.text_secondary'))
                .backgroundColor($r('app.color.tag_background'))
                .borderRadius(4)
                .padding({ left: 6, right: 6, top: 3, bottom: 3 })
            }

            // ä»Šæ—¥çŠ¶æ€æ ‡ç­¾
            if (this.todayStatus) {
              Text(this.todayStatus)
                .fontSize(11)
                .fontColor($r('app.color.text_secondary'))
                .backgroundColor($r('app.color.tag_background'))
                .borderRadius(4)
                .padding({ left: 6, right: 6, top: 3, bottom: 3 })
                .margin({ left: 6 })
            }

            // å…³äºå•†æˆ·æŒ‰é’®
            Row() {
              Text('é—œæ–¼å•†æˆ¶')
                .fontSize(11)
                .fontColor($r('app.color.text_secondary'))
              Text(' â“˜')
                .fontSize(10)
                .fontColor($r('app.color.text_secondary'))
            }
            .backgroundColor($r('app.color.card_background'))
            .borderRadius(4)
            .padding({ left: 6, right: 6, top: 3, bottom: 3 })
            .border({ width: 1, color: '#E0E0E0' })
            .margin({ left: 6 })
            .onClick(() => {
              this.showStoreInfo();
            })
          }
          .margin({ top: 8 })
        }
        .alignItems(HorizontalAlign.Start)
        .margin({ left: 12, top: 25 })
        .layoutWeight(1)
      }
      .width('100%')
      .alignItems(VerticalAlign.Top)
    }
    .width('100%')
    .height(120)
  }

  // å…¬å‘Šæ 
  @Builder
  NoticeBar() {
    Row() {
      // å…¬å‘Šæ ‡ç­¾
      Text('å…¬å‘Š:')
        .fontSize(13)
        .fontWeight(FontWeight.Medium)
        .fontColor($r('app.color.text_primary'))
        .margin({ left: 12 })

      // å…¬å‘Šå†…å®¹
      Text(this.notices.join(' | '))
        .fontSize(13)
        .fontColor($r('app.color.text_secondary'))
        .maxLines(this.showNoticeExpand ? 10 : 1)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
        .layoutWeight(1)
        .margin({ left: 8, right: 8 })

      // å±•å¼€ç®­å¤´
      Text(this.showNoticeExpand ? 'â–²' : 'â–¼')
        .fontSize(12)
        .fontColor($r('app.color.text_hint'))
        .margin({ right: 12 })
        .onClick(() => {
          this.showNoticeExpand = !this.showNoticeExpand;
        })
    }
    .width('100%')
    .padding({ top: 10, bottom: 10 })
    .backgroundColor($r('app.color.notice_background'))
    .alignItems(VerticalAlign.Center)
  }

  // Tab å¯¼èˆªæ 
  @Builder
  TabBar() {
    Row() {
      // ä¸»é  Tab
      Column() {
        Text('ä¸»é ')
          .fontSize(15)
          .fontColor(this.currentTab === 0 ? $r('app.color.text_primary') : $r('app.color.tab_inactive'))
          .fontWeight(this.currentTab === 0 ? FontWeight.Bold : FontWeight.Normal)
        if (this.currentTab === 0) {
          Column()
            .width(30)
            .height(3)
            .backgroundColor(this.themeColor)
            .borderRadius(2)
            .margin({ top: 6 })
        }
      }
      .layoutWeight(1)
      .height(48)
      .justifyContent(FlexAlign.Center)
      .onClick(() => {
        // è¿”å›é¦–é¡µ
        router.back();
      })

      // é»é¤ Tab
      Column() {
        Text('é»é¤')
          .fontSize(15)
          .fontColor(this.currentTab === 1 ? $r('app.color.text_primary') : $r('app.color.tab_inactive'))
          .fontWeight(this.currentTab === 1 ? FontWeight.Bold : FontWeight.Normal)
        if (this.currentTab === 1) {
          Column()
            .width(30)
            .height(3)
            .backgroundColor(this.themeColor)
            .borderRadius(2)
            .margin({ top: 6 })
        }
      }
      .layoutWeight(1)
      .height(48)
      .justifyContent(FlexAlign.Center)
      .onClick(() => {
        this.currentTab = 1;
      })

      // æ­·å²è¨‚å–® Tab
      Column() {
        Text('æ­·å²è¨‚å–®')
          .fontSize(15)
          .fontColor(this.currentTab === 2 ? $r('app.color.text_primary') : $r('app.color.tab_inactive'))
          .fontWeight(this.currentTab === 2 ? FontWeight.Bold : FontWeight.Normal)
        if (this.currentTab === 2) {
          Column()
            .width(50)
            .height(3)
            .backgroundColor(this.themeColor)
            .borderRadius(2)
            .margin({ top: 6 })
        }
      }
      .layoutWeight(1)
      .height(48)
      .justifyContent(FlexAlign.Center)
      .onClick(() => {
        this.currentTab = 2;
        // TODO: è·³è½¬åˆ°å†å²è®¢å•é¡µ
        hilog.info(DOMAIN, TAG, 'Navigate to order history');
      })
    }
    .width('100%')
    .backgroundColor($r('app.color.card_background'))
    .border({ width: { bottom: 1 }, color: $r('app.color.divider') })
  }

  // æœåŠ¡ç±»å‹å¤´éƒ¨
  @Builder
  ServiceHeader() {
    Row() {
      // å·¦ä¾§ï¼šæœåŠ¡ç±»å‹å›¾æ ‡å’Œæ–‡å­—
      Row() {
        // å¤–å–/è‡ªå–å›¾æ ‡
        Text('ğŸ“¦')
          .fontSize(16)
        Text(this.orderType === OrderType.PICKUP ? 'å¤–è³£è‡ªå–' : 'å ‚é£Ÿ')
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor($r('app.color.text_primary'))
          .margin({ left: 6 })
      }
      .padding({ left: 12 })

      Blank()

      // å³ä¾§ï¼šè¯­è¨€åˆ‡æ¢
      Row() {
        Text(this.currentLang)
          .fontSize(13)
          .fontColor($r('app.color.text_secondary'))
        Text(' Language')
          .fontSize(12)
          .fontColor($r('app.color.text_hint'))
      }
      .padding({ right: 12 })
      .onClick(() => {
        // åˆ‡æ¢è¯­è¨€
        this.currentLang = this.currentLang === 'ç¹' ? 'ç®€' : 'ç¹';
        hilog.info(DOMAIN, TAG, 'Switch language to: %{public}s', this.currentLang);
      })
    }
    .width('100%')
    .height(44)
    .backgroundColor($r('app.color.card_background'))
    .alignItems(VerticalAlign.Center)
    .border({ width: { bottom: 1 }, color: $r('app.color.divider') })
  }

  // åŠ è½½ä¸­
  @Builder
  LoadingView() {
    Column() {
      LoadingProgress()
        .width(60)
        .height(60)
        .color(this.themeColor)
      Text('è¼‰å…¥èœå–®ä¸­...')
        .fontSize(14)
        .fontColor($r('app.color.text_hint'))
        .margin({ top: 16 })
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }

  // å·¦ä¾§åˆ†ç±»åˆ—è¡¨
  @Builder
  CategoryList() {
    List({ scroller: this.categoryScroller }) {
      ForEach(this.productGroups, (group: ProductGroup, index: number) => {
        ListItem() {
          Column() {
            Text(group.local_name)
              .fontSize(13)
              .fontColor(this.selectedGroupIndex === index ?
                this.themeColor : $r('app.color.text_secondary'))
              .fontWeight(this.selectedGroupIndex === index ?
                FontWeight.Bold : FontWeight.Normal)
              .maxLines(2)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .textAlign(TextAlign.Center)
          }
          .width('100%')
          .height(56)
          .justifyContent(FlexAlign.Center)
          .padding({ left: 6, right: 6 })
          .backgroundColor(this.selectedGroupIndex === index ?
            $r('app.color.card_background') : 'transparent')
          .borderRadius({ topRight: 6, bottomRight: 6 })
          .onClick(() => {
            this.selectedGroupIndex = index;
            // æ»šåŠ¨åˆ°å¯¹åº”åˆ†ç»„
            this.scroller.scrollToIndex(this.getProductListIndexForGroup(index));
          })
        }
      })
    }
    .width(85)
    .height('100%')
    .backgroundColor($r('app.color.service_card_background'))
  }

  // å³ä¾§äº§å“åˆ—è¡¨
  @Builder
  ProductList() {
    List({ scroller: this.scroller }) {
      ForEach(this.productGroups, (group: ProductGroup, groupIndex: number) => {
        // åˆ†ç»„æ ‡é¢˜
        ListItem() {
          Row() {
            Text(group.local_name)
              .fontSize(15)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))

            // ä¾›åº”æ—¶é—´ï¼ˆå¦‚æœæœ‰ï¼‰
            if (group.time_range) {
              Text(`  ä¾›æ‡‰æ™‚é–“ ${group.time_range}`)
                .fontSize(12)
                .fontColor($r('app.color.text_hint'))
            } else {
              Text('  ä¾›æ‡‰æ™‚é–“-')
                .fontSize(12)
                .fontColor($r('app.color.text_hint'))
            }
          }
          .width('100%')
          .padding({ left: 12, top: 14, bottom: 8 })
        }

        // äº§å“åˆ—è¡¨
        ForEach(group.products, (product: Product) => {
          ListItem() {
            this.ProductItem(product)
          }
        })
      })
    }
    .layoutWeight(1)
    .height('100%')
    .padding({ right: 8 })
    .onScrollIndex((firstIndex: number) => {
      // æ›´æ–°é€‰ä¸­çš„åˆ†ç±»
      let currentGroup = 0;
      let itemCount = 0;
      for (let i = 0; i < this.productGroups.length; i++) {
        if (firstIndex <= itemCount) {
          currentGroup = i;
          break;
        }
        itemCount += this.productGroups[i].products.length + 1;
        currentGroup = i;
      }
      if (this.selectedGroupIndex !== currentGroup) {
        this.selectedGroupIndex = currentGroup;
        // åŒæ­¥æ»šåŠ¨å·¦ä¾§åˆ†ç±»åˆ—è¡¨
        this.categoryScroller.scrollToIndex(currentGroup);
      }
    })
  }

  // äº§å“é¡¹
  @Builder
  ProductItem(product: Product) {
    Row() {
      // äº§å“å›¾ç‰‡
      if (product.cover_image) {
        Image(product.cover_image)
          .width(85)
          .height(85)
          .borderRadius(8)
          .objectFit(ImageFit.Cover)
      } else {
        Column()
          .width(85)
          .height(85)
          .borderRadius(8)
          .backgroundColor($r('app.color.tag_background'))
      }

      // äº§å“ä¿¡æ¯
      Column() {
        // äº§å“åç§°
        Text(product.local_name)
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor($r('app.color.text_primary'))
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        // äº§å“æè¿°
        if (product.description?.local_description) {
          Text(product.description.local_description)
            .fontSize(11)
            .fontColor($r('app.color.text_hint'))
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .margin({ top: 3 })
        }

        Blank()

        // ä»·æ ¼å’Œæ·»åŠ æŒ‰é’®
        Row() {
          // ä»·æ ¼
          Text(`${this.currencySymbol}${this.getPrice(product)}`)
            .fontSize(15)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.themeColor)

          Blank()

          // æ·»åŠ æŒ‰é’®
          Button('+')
            .width(30)
            .height(30)
            .fontSize(18)
            .fontColor($r('app.color.text_primary'))
            .backgroundColor(this.themeColor)
            .borderRadius(15)
            .onClick(() => {
              this.addToCart(product);
            })
        }
        .width('100%')
      }
      .layoutWeight(1)
      .height(85)
      .alignItems(HorizontalAlign.Start)
      .justifyContent(FlexAlign.SpaceBetween)
      .margin({ left: 10 })
    }
    .width('100%')
    .padding(10)
    .backgroundColor($r('app.color.card_background'))
    .borderRadius(10)
    .margin({ top: 6, left: 8 })
  }

  aboutToAppear() {
    // è·å–è·¯ç”±å‚æ•°
    const params = router.getParams() as Record<string, Object>;
    if (params) {
      this.orderType = (params['orderType'] as OrderType) || OrderType.PICKUP;
      this.themeColor = (params['themeColor'] as string) || '#FFD700';

      // ä»è·¯ç”±å‚æ•°è·å–åº—é“ºä¿¡æ¯
      if (params['storeName']) {
        this.storeName = params['storeName'] as string;
      }
      if (params['storeImage']) {
        this.storeImage = params['storeImage'] as string;
      }
      if (params['notices']) {
        this.notices = params['notices'] as string[];
      }
      if (params['isOpen'] !== undefined) {
        this.isOpen = params['isOpen'] as boolean;
      }
      if (params['storeStatus']) {
        this.storeStatus = params['storeStatus'] as string;
      }
      if (params['todayStatus']) {
        this.todayStatus = params['todayStatus'] as string;
      }
    }

    // å¦‚æœæ²¡æœ‰ä»è·¯ç”±è·å–åˆ°åº—é“ºä¿¡æ¯ï¼Œåˆ™åŠ è½½
    if (!this.storeName) {
      this.loadStoreData();
    }

    this.loadMenuData();
  }

  /**
   * åŠ è½½åº—é“ºæ•°æ®
   */
  private async loadStoreData(): Promise<void> {
    try {
      const response = await apiService.getHomeData();

      if (response.code === 200 && response.data) {
        this.updateStoreInfo(response.data);
      }
    } catch (error) {
      hilog.error(DOMAIN, TAG, 'Failed to load store data: %{public}s', JSON.stringify(error));
      // ä½¿ç”¨é»˜è®¤æ•°æ®
      this.storeName = 'è€é¦®èŒ¶å±…';
    }
  }

  /**
   * æ›´æ–°åº—é“ºä¿¡æ¯
   */
  private updateStoreInfo(data: HomeData): void {
    const config = data.config;

    this.storeName = config.name || 'åº—é“ºåç§°';
    this.storeImage = config.store_image || '';

    this.isOpen = config.is_close !== 1;
    if (!this.isOpen) {
      this.storeStatus = 'å•†å®¶ä¼‘æ¯ä¸­';
      this.todayStatus = 'ä»Šæ—¥ä¼‘æ¥­';
    }

    if (data.notice && data.notice.length > 0) {
      this.notices = data.notice.map(n => n.local_name);
    }
  }

  /**
   * åŠ è½½èœå•æ•°æ®
   */
  private async loadMenuData(): Promise<void> {
    try {
      const takeout = this.orderType === OrderType.PICKUP ? 1 : 0;
      const response = await apiService.getProductMenus(takeout);

      if (response.code === 200 && response.data) {
        this.productGroups = response.data.group || [];
        hilog.info(DOMAIN, TAG, 'Menu loaded: %{public}d groups', this.productGroups.length);
      }
    } catch (error) {
      hilog.error(DOMAIN, TAG, 'Failed to load menu: %{public}s', JSON.stringify(error));
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * è·å–äº§å“ä»·æ ¼
   */
  private getPrice(product: Product): string {
    if (this.orderType === OrderType.PICKUP) {
      return product.takeout_price || product.price;
    }
    return product.price;
  }

  /**
   * è®¡ç®—åˆ†ç»„åœ¨äº§å“åˆ—è¡¨ä¸­çš„èµ·å§‹ç´¢å¼•
   */
  private getProductListIndexForGroup(groupIndex: number): number {
    let index = 0;
    for (let i = 0; i < groupIndex; i++) {
      index += this.productGroups[i].products.length + 1; // +1 for group header
    }
    return index;
  }

  /**
   * æ·»åŠ åˆ°è´­ç‰©è½¦
   */
  private addToCart(product: Product): void {
    hilog.info(DOMAIN, TAG, 'Add to cart: %{public}s', product.local_name);
    // TODO: å®ç°è´­ç‰©è½¦é€»è¾‘
  }

  /**
   * æ˜¾ç¤ºåº—é“ºè¯¦æƒ…
   */
  private showStoreInfo(): void {
    hilog.info(DOMAIN, TAG, 'Show store info');
    // TODO: è·³è½¬åˆ°åº—é“ºè¯¦æƒ…é¡µ
  }
}
